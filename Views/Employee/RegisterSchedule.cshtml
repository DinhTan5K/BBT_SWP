@{
    Layout = "_EmployeeLayout";
    ViewData["Title"] = "ƒêƒÉng k√Ω l·ªãch l√†m";
    ViewBag.ActiveMenu = "RegisterSchedule";
}

@Html.AntiForgeryToken()

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />
    <link href="~/css/employee/register-schedule.css" rel="stylesheet" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

}

<div class="schedule-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="title mb-0">üìÖ ƒêƒÉng k√Ω l·ªãch l√†m vi·ªác</h5>
            <div class="subtitle">K√©o th·∫£ ca m·∫´u v√†o l·ªãch ho·∫∑c click v√†o ng√†y ƒë·ªÉ ƒëƒÉng k√Ω.</div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-3">
            <h6 class="fw-semibold mb-3 text-secondary">K√©o th·∫£ ca m·∫´u</h6>
            <div id="external-events" class="p-2 border rounded-3 bg-light">
                <div class="fc-event-template" data-shift-type="S√°ng" style="background-color:#f59e0b;">Ca S√°ng (8h -
                    15h)</div>
                <div class="fc-event-template" data-shift-type="T·ªëi" style="background-color:#3b82f6;">Ca T·ªëi (15h -
                    22h)</div>
            </div>

            <hr class="my-4" />

            <h6 class="fw-semibold mb-3 text-secondary">Ch√∫ th√≠ch</h6>
            <div class="legend"> @* C·∫≠p nh·∫≠t ch√∫ th√≠ch ƒë·ªÉ kh·ªõp v·ªõi logic m·ªõi *@
                <div class="legend-item"><span class="legend-box event-done"></span> ƒê√£ l√†m</div>
                <div class="legend-item"><span class="legend-box event-approved"></span> ƒê√£ duy·ªát</div>
                <div class="legend-item"><span class="legend-box event-pending"></span> Ch·ªù duy·ªát</div>
            </div>

            <div class="summary-box mt-4">
                T·ªïng s·ªë ca (ch∆∞a l√†m): <strong id="totalShifts">0</strong>
            </div>
        </div>

        <div class="col-lg-9">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="registerShiftModal" tabindex="-1" aria-labelledby="registerShiftModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-2">
            <div class="modal-header">
                <h5 class="modal-title" id="registerShiftModalLabel">ƒêƒÉng k√Ω ca l√†m</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>B·∫°n mu·ªën ƒëƒÉng k√Ω ca cho ng√†y: <strong id="modalSelectedDate"></strong></p>
                <div class="mb-3">
                    <label for="shiftTypeSelect" class="form-label">Ch·ªçn ca l√†m:</label>
                    <select id="shiftTypeSelect" class="form-select">
                        <option value="S√°ng">Ca S√°ng (8h-15h)</option>
                        <option value="T·ªëi">Ca T·ªëi (15h-22h)</option>
                    </select>
                </div>
                <input type="hidden" id="workDate" />
                <div id="register-error-message"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="saveShiftBtn">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- 1. KH·ªûI T·∫†O BI·∫æN ---
            const token = $('input[name="__RequestVerificationToken"]').val();
            const modal = new bootstrap.Modal(document.getElementById('registerShiftModal'));
            const calendarEl = document.getElementById('calendar');
            const errorMessageDiv = $('#register-error-message');

            // --- 2. K√çCH HO·∫†T K√âO-TH·∫¢ CHO CA M·∫™U ---
            new FullCalendar.Draggable(document.getElementById('external-events'), {
                itemSelector: '.fc-event-template',
                eventData: el => ({
                    title: el.innerText,
                    shiftType: el.dataset.shiftType,
                    duration: '07:00'
                })
            });

            // --- 3. KH·ªûI T·∫†O L·ªäCH (FULLCALENDAR) ---
            const calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'vi',
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek' // Cho ph√©p xem th√°ng/tu·∫ßn
                },
                events: {
                    url: '@Url.Action("GetMySchedules", "Employee")',
                    failure: () => Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu l·ªãch l√†m vi·ªác.', 'error')
                },
                droppable: true,  // Cho ph√©p th·∫£ ca v√†o
                selectable: true, // Cho ph√©p click v√†o ng√†y
                editable: false,  // Kh√¥ng cho nh√¢n vi√™n k√©o-th·∫£ ca ƒë√£ c√≥

                // --- 4. X·ª¨ L√ù S·ª∞ KI·ªÜN CLICK V√ÄO NG√ÄY (M·ªû MODAL) ---
                dateClick(info) {
                    if (info.date < new Date().setHours(0, 0, 0, 0)) {
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ ƒëƒÉng k√Ω l·ªãch cho ng√†y trong qu√° kh·ª©.', 'error');
                        return;
                    }
                    $('#workDate').val(info.dateStr);
                    $('#modalSelectedDate').text(new Date(info.dateStr).toLocaleDateString('vi-VN'));
                    errorMessageDiv.removeClass('show').text('');
                    modal.show();
                },

                // --- 5. X·ª¨ L√ù S·ª∞ KI·ªÜN K√âO-TH·∫¢ CA M·∫™U V√ÄO L·ªäCH ---
                eventReceive(info) {
                    var workDate = info.event.start; // L·∫•y ƒë·ªëi t∆∞·ª£ng Date
                    var shiftType = info.draggedEl.dataset.shiftType; // L·∫•y lo·∫°i ca t·ª´ data-shift-type

                    
                    // T·∫°o chu·ªói "yyyy-MM-dd" th·ªß c√¥ng, b·ªè qua m·ªçi m√∫i gi·ªù
                    var year = workDate.getFullYear();
                    var month = (workDate.getMonth() + 1).toString().padStart(2, '0'); // +1 v√¨ th√°ng b·∫Øt ƒë·∫ßu t·ª´ 0
                    var day = workDate.getDate().toString().padStart(2, '0');
                    var dateString = `${year}-${month}-${day}`;
               

                    // Ki·ªÉm tra ng√†y qu√° kh·ª©
                    if (workDate.setHours(0, 0, 0, 0) < new Date().setHours(0, 0, 0, 0)) { // So s√°nh ch·ªâ ng√†y
                        Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ ƒëƒÉng k√Ω l·ªãch cho ng√†y trong qu√° kh·ª©.', 'error');
                        info.event.remove(); // X√≥a ca v·ª´a th·∫£
                        return;
                    }
                    const data = {
                        WorkDate: dateString, // <-- S·ª≠ d·ª•ng dateString ƒë√£ s·ª≠a
                        ShiftType: shiftType
                    };

                    // G·ª≠i AJAX ƒë·ªÉ ƒëƒÉng k√Ω
                    $.ajax({
                        url: '@Url.Action("RegisterSelfForShift", "Employee")',
                        method: 'POST',
                        headers: { 'RequestVerificationToken': token },
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        success(res) {
                            calendar.refetchEvents(); // T·∫£i l·∫°i l·ªãch
                            if (res.success) {
                                Swal.fire('Th√†nh c√¥ng', res.message, 'success');
                            } else {
                                Swal.fire('L·ªói', res.message, 'error');
                            }
                        },
                        error(xhr) {
                            Swal.fire('L·ªói', xhr.responseText, 'error');
                            calendar.refetchEvents(); // T·∫£i l·∫°i ƒë·ªÉ x√≥a ca t·∫°m
                        }
                    });
                },

                // --- 6. X·ª¨ L√ù S·ª∞ KI·ªÜN CLICK V√ÄO CA (ƒê·ªÇ H·ª¶Y) ---
                eventClick(info) {
                    if (info.event.extendedProps.status === 'Ch∆∞a duy·ªát') { // Ch·ªâ cho ph√©p h·ªßy ca "Ch∆∞a duy·ªát"
                        Swal.fire({
                            title: 'H·ªßy ƒëƒÉng k√Ω ca?',
                            text: `B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ca ${info.event.title} ng√†y ${info.event.start.toLocaleDateString('vi-VN')}?`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonText: 'Kh√¥ng',
                            confirmButtonText: 'ƒê√∫ng, h·ªßy ca!'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // G·ª≠i AJAX ƒë·ªÉ h·ªßy
                                $.ajax({
                                    url: '@Url.Action("CancelShift", "Employee")',
                                    method: 'POST',
                                    headers: { 'RequestVerificationToken': token },
                                    contentType: 'application/json',
                                    data: JSON.stringify({ id: info.event.id }),
                                    success(res) {
                                        if (res.success) {
                                            info.event.remove(); // X√≥a ca kh·ªèi l·ªãch
                                            updateSummary(); // C·∫≠p nh·∫≠t t·ªïng s·ªë ca
                                            Swal.fire('ƒê√£ h·ªßy', res.message, 'success');
                                        } else {
                                            Swal.fire('L·ªói', res.message, 'error');
                                        }
                                    },
                                    error(xhr) { Swal.fire('L·ªói', xhr.responseText, 'error'); }
                                });
                            }
                        });
                    }
                },

                // --- 7. T√ôY CH·ªàNH HI·ªÇN TH·ªä M√ÄU S·∫ÆC ---
                eventClassNames(arg) {
                    const s = arg.event.extendedProps.status;
                    if (s === 'ƒê√£ l√†m') return ['event-done'];
                    if (s === 'ƒê√£ duy·ªát') return ['event-approved'];
                    if (s === 'Ch∆∞a duy·ªát') return ['event-pending'];
                    return [];
                },

                // --- 8. C·∫¨P NH·∫¨T T·ªîNG S·ªê CA SAU KHI T·∫¢I ---
                eventsSet: function (events) {
                    updateSummary();
                }
            });

            calendar.render(); // V·∫Ω l·ªãch

            // --- 9. X·ª¨ L√ù N√öT "L∆ØU" TRONG MODAL ---
            $('#saveShiftBtn').click(function () {
                const data = {
                    WorkDate: $('#workDate').val(),
                    ShiftType: $('#shiftTypeSelect').val()
                };

                $.ajax({
                    url: '@Url.Action("RegisterSelfForShift", "Employee")',
                    method: 'POST',
                    headers: { 'RequestVerificationToken': token },
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success(res) {
                        if (res.success) {
                            modal.hide();
                            calendar.refetchEvents(); // T·∫£i l·∫°i l·ªãch
                            Swal.fire('Th√†nh c√¥ng', res.message, 'success');
                        } else {
                            errorMessageDiv.addClass('show').text(res.message || "L·ªói khi ƒëƒÉng k√Ω.");
                        }
                    },
                    error(xhr) {
                        errorMessageDiv.addClass('show').text(xhr.responseText || "L·ªói k·∫øt n·ªëi.");
                    }
                });
            });

            // --- 10. C√ÅC H√ÄM HELPER ---

            // X√≥a l·ªói khi ƒë√≥ng modal
            $('#registerShiftModal').on('hidden.bs.modal', function () {
                errorMessageDiv.removeClass('show').text('');
            });

            // C·∫≠p nh·∫≠t t·ªïng s·ªë ca (ch·ªâ ƒë·∫øm ca ch∆∞a l√†m)
            function updateSummary() {
                var validEvents = calendar.getEvents().filter(e => e.extendedProps.status === 'ƒê√£ duy·ªát' || e.extendedProps.status === 'Ch∆∞a duy·ªát');
                $('#totalShifts').text(validEvents.length);
            }
        });
    </script>
}