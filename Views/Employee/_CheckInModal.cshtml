@model dynamic
@{
    bool canStart = Model != null && (Model.canStart is bool c && c);
    string message = Model?.message ?? "";
    bool isCheckIn = Model != null && (Model.isCheckIn is bool i) ? (bool)Model.isCheckIn : false;
    int? workScheduleId = Model?.workScheduleId;
}


<div class="modal fade" id="checkInModal" tabindex="-1" aria-labelledby="checkInModalLabel" aria-hidden="true"
     data-is-checkin="@isCheckIn.ToString().ToLower()"
     data-work-schedule-id="@(workScheduleId?.ToString() ?? "")">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas @(isCheckIn ? "fa-sign-in-alt" : "fa-sign-out-alt") me-2"></i>
                    @(isCheckIn ? "Check-in b·∫±ng khu√¥n m·∫∑t" : "Check-out b·∫±ng khu√¥n m·∫∑t")
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                @if (!canStart)
                {
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>@message
                    </div>
                }
                else
                {
                    <div class="text-center mb-3">
                        <p class="text-muted">
                            ƒê∆∞a khu√¥n m·∫∑t c·ªßa b·∫°n v√†o khung ƒë·ªÉ @(isCheckIn ? "ƒëi·ªÉm danh v√†o ca" : "x√°c nh·∫≠n k·∫øt th√∫c ca").
                        </p>
                    </div>

                    <div class="camera-container text-center mb-3">
                        <video id="video" autoplay playsinline style="width: 100%; max-width: 640px; border-radius: 8px;"></video>
                       <canvas id="canvas" style="display: none;"></canvas>
<img id="previewImage" src="" alt="·∫¢nh ƒë√£ ch·ª•p"
     class="img-fluid mt-3 rounded shadow-sm"
     style="display:none; max-width: 320px;">

                        
                    </div>

                    <div class="text-center">
                        <button id="captureBtn" class="btn btn-primary"><i class="fas fa-camera"></i> Ch·ª•p ·∫£nh</button>
                        <button id="submitBtn" class="btn btn-success" disabled>
                            <i class="fas fa-check-circle"></i> X√°c nh·∫≠n @(isCheckIn ? "Check-in" : "Check-out")
                        </button>
                    </div>

                    <div id="alertBox" class="alert mt-3 text-center" style="display:none;"></div>
                }
            </div>
        </div>
    </div>
</div>

<script>
// ==========================
// INIT VARIABLES
// ==========================
const modalEl = document.getElementById('checkInModal');
const canvas = document.getElementById('canvas');
const captureBtn = document.getElementById('captureBtn');
const submitBtn = document.getElementById('submitBtn');
const alertBox = document.getElementById('alertBox');
const isCheckIn = modalEl ? modalEl.dataset.isCheckin === 'true' : true;
const workScheduleIdValue = modalEl ? modalEl.dataset.workScheduleId : null;
const workScheduleId = workScheduleIdValue ? parseInt(workScheduleIdValue) : null;

let stream, imageData;

// ==========================
// CAMERA FUNCTIONS
// ==========================
async function initCamera() {
    try {
        // T√¨m l·∫°i modal v√† video m·ªói l·∫ßn g·ªçi ƒë·ªÉ ƒë·∫£m b·∫£o t√¨m ƒë√∫ng
        const currentModal = document.getElementById('checkInModal');
        if (!currentModal) {
            console.error("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y modal element");
            return;
        }
        
        const video = currentModal.querySelector('#video');
        if (!video) {
            console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ <video> trong modal.");
            console.log('Modal HTML:', currentModal.innerHTML.substring(0, 500));
            // Th·ª≠ l·∫°i sau 100ms
           setTimeout(() => {
    const bootstrapModal = bootstrap.Modal.getInstance(modalEl);
    if (bootstrapModal) bootstrapModal.hide();

    // üîÑ Reload c·ª©ng, kh√¥ng cache, ƒë·ªÉ d·ªØ li·ªáu check-in/out c·∫≠p nh·∫≠t ngay
    window.location.replace("/Employee/Schedule");
}, 2000);


            return;
        }

        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            showError("Tr√¨nh duy·ªát ch·ªâ cho ph√©p truy c·∫≠p camera qua HTTPS ho·∫∑c localhost.");
            return;
        }

        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        video.srcObject = stream;
        video.setAttribute('playsinline', 'true');

        await video.play().catch(e => console.warn('Video play blocked:', e));
        console.log('‚úÖ Camera initialized successfully');
    } catch (err) {
        console.error('Camera error:', err);
        showError("Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p (b·ªã ch·∫∑n ho·∫∑c ch∆∞a c·∫•p quy·ªÅn).");
    }
}

function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
}

// ==========================
// EVENT: CH·ª§P ·∫¢NH
// ==========================
captureBtn?.addEventListener('click', () => {
    const video = modalEl ? modalEl.querySelector('#video') : document.getElementById('video');
    if (!video) return showError("Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ camera ƒë·ªÉ ch·ª•p.");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    imageData = canvas.toDataURL('image/jpeg', 0.8);
    submitBtn.disabled = false;
    showSuccess("·∫¢nh ƒë√£ ƒë∆∞·ª£c ch·ª•p. B·∫•m X√°c nh·∫≠n ƒë·ªÉ g·ª≠i.");

    // ‚úÖ TH√äM ·ªû ƒê√ÇY ‚Äî hi·ªÉn th·ªã ·∫£nh v·ª´a ch·ª•p b√™n d∆∞·ªõi camera
    const preview = document.getElementById('previewImage');
    if (preview && imageData) {
        preview.src = imageData;
        preview.style.display = 'block';
    }
});


// ==========================
// EVENT: G·ª¨I D·ªÆ LI·ªÜU CHECK-IN/OUT
// ==========================
submitBtn?.addEventListener('click', async () => {
    if (!imageData) {
        showError("Ch∆∞a ch·ª•p ·∫£nh!");
        return;
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang g·ª≠i...';

    try {
        const url = isCheckIn ? '/Employee/DoCheckIn' : '/Employee/DoCheckOut';

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ WorkScheduleId: workScheduleId, ImageBase64: imageData })
        });

        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

        const result = await res.json();

        if (result.success) {
            console.log('‚úÖ Th√†nh c√¥ng:', result.message);
            showSuccess(result.message || (isCheckIn ? "Check-in th√†nh c√¥ng!" : "Check-out th√†nh c√¥ng!"));
            setTimeout(() => {
                const bootstrapModal = bootstrap.Modal.getInstance(modalEl);
                if (bootstrapModal) bootstrapModal.hide();
                location.href = `/Employee/Schedule?ok=${encodeURIComponent(result.message)}`;
            }, 2000);
        } else {
            showError(result.message || "C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> X√°c nh·∫≠n';
        }
    } catch (error) {
        console.error('Submit error:', error);
        showError("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng th·ª≠ l·∫°i.");
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> X√°c nh·∫≠n';
    }
});

// ==========================
// ALERT FUNCTIONS
// ==========================
function showError(msg) {
    const box = modalEl ? modalEl.querySelector('#alertBox') : document.getElementById('alertBox');
    if (!box) {
        console.error('AlertBox not found, using alert()');
        alert('L·ªñI: ' + msg);
        return;
    }

    // üîπ Th√™m class 'show' v√† style r√µ r√†ng
    box.className = 'alert alert-danger text-center show';
    box.style.display = 'block';
    box.innerHTML = `<i class="fas fa-times-circle me-2"></i>${msg}`;
}

function showSuccess(msg) {
    const box = modalEl ? modalEl.querySelector('#alertBox') : document.getElementById('alertBox');
    if (!box) {
        console.error('AlertBox not found, using alert()');
        alert('TH√ÄNH C√îNG: ' + msg);
        return;
    }

    // üîπ Th√™m class 'show' ƒë·ªÉ ch·∫°y animation
    box.className = 'alert alert-success text-center show';
    box.style.display = 'block';
    box.innerHTML = `<i class="fas fa-check-circle me-2"></i>${msg}`;
}


// ==========================
// CH·ªú MODAL HI·ªÜN XONG R·ªíI M·ªöI KH·ªûI ƒê·ªòNG CAMERA
// ==========================
modalEl.addEventListener('shown.bs.modal', () => {
    console.log("üé• Modal shown ‚Üí Starting camera...");
    initCamera();
});

// Khi ƒë√≥ng modal th√¨ t·∫Øt camera ƒë·ªÉ tr√°nh chi·∫øm t√†i nguy√™n
modalEl.addEventListener('hidden.bs.modal', () => {
    console.log("üõë Modal hidden ‚Üí Stopping camera...");
    stopCamera();
});
</script>
