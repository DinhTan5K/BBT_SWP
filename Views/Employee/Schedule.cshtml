@model start.Models.MonthScheduleDto
@using System.Globalization
<link rel="stylesheet" href="~/css/employee/schedule.css" />

@{
    Layout = "_EmployeeLayout";
    var vi = CultureInfo.GetCultureInfo("vi-VN");
    ViewBag.ActiveMenu = "Schedule";
    ViewBag.ActiveTab  = "schedule";

    // Chuẩn bị dữ liệu cho lịch
    var year = Model.Year;
    var month = Model.Month;
    var firstOfMonth = new DateTime(year, month, 1);
    var daysInMonth  = DateTime.DaysInMonth(year, month);

    // Lấy thứ bắt đầu theo chuẩn Thứ 2 → CN (ISO)
    // DayOfWeek: Sunday=0 ... Saturday=6
    int ToIsoDow(DayOfWeek d) => d == DayOfWeek.Sunday ? 7 : (int)d;
    var startIsoDow = ToIsoDow(firstOfMonth.DayOfWeek); // 1..7 (Mon..Sun)
    // Map nhanh các ngày có ca làm (đã được duyệt)
    var workByDate = Model.Items
        .Where(s => s.Status == "Đã duyệt")
        .GroupBy(x => x.Date.Date)
        .ToDictionary(g => g.Key, g => g.ToList());

    // Lấy ID các ca đã có chấm công hoàn chỉnh để xác định trạng thái "Đã làm"
    var scheduleIds = Model.Items.Select(i => i.WorkScheduleID).ToList();
    var completedAttendanceScheduleIds = new HashSet<int>(
        ViewBag.CompletedAttendances as List<int> ?? new List<int>()
    );

    string[] dowHeaders = new[] { "T2", "T3", "T4", "T5", "T6", "T7", "CN" };

    // Lấy thông tin từ ViewBag
    var todayCheckIn = ViewBag.TodayCheckIn as start.Models.Attendance;
    var todaySchedules = ViewBag.TodaySchedules as List<WorkSchedule> ?? new List<WorkSchedule>();
    var employeeId = ViewBag.EmployeeId as string ?? "";
}



<div class="card shadow-sm mb-3">

@if (TempData["err"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show mt-3 text-center" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>@TempData["err"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

  <div class="card-header calendar-header">
    <div>
      <div class="fw-semibold">Lịch làm việc tháng @month/@year</div>
      <div class="text-muted small">Nhân viên: @Model.Employee.FullName</div>
    </div>

    <form method="get" asp-controller="Employee" asp-action="Schedule" asp-route-id="@Model.Employee.EmployeeID" class="calendar-filter">
      <select name="month" class="form-control">
        @for (int m = 1; m <= 12; m++)
        {
            <option value="@m" selected="@(m==Model.Month)">Tháng @m</option>
        }
      </select>
      <select name="year" class="form-control">
        @for (int y = DateTime.Now.Year-2; y <= DateTime.Now.Year+2; y++)
        {
            <option value="@y" selected="@(y==Model.Year)">@y</option>
        }
      </select>
      <button class="btn btn-outline-primary">Xem</button>
      <button type="button" class="btn btn-primary d-none d-print-inline-block print-hidden" onclick="window.print()">In lịch</button>
    </form>
  </div>

  <div class="card-body">
    <div class="calendar">
      <div class="calendar-grid">
        @* Header thứ *@
        @foreach (var h in dowHeaders)
        {
            <div class="cal-cell cal-head">@h</div>
        }

        @* Ô trống trước ngày 1 (nếu tháng không bắt đầu từ Thứ 2) *@
        @{
            for (int i = 1; i < startIsoDow; i++)
            {
                <div class="cal-cell cal-empty"></div>
            }
        }

        @* Các ngày trong tháng *@
        @{
            for (int day = 1; day <= daysInMonth; day++)
            {
                var d = new DateTime(year, month, day);
                bool isToday = d.Date == DateTime.Today;
                bool hasWork = workByDate.ContainsKey(d.Date);

                var cellClass = "cal-cell cal-day";
                if (isToday)  cellClass += " today";
                if (hasWork)  cellClass += " workday";

                <div class="@cellClass">
                  <div class="cal-date">
                    <span class="date-number">@day</span>
                  </div>

                  @if (hasWork)
                  {
                      var entries = workByDate[d.Date];
                      foreach (var w in entries)
                      {
                          // --- SỬA LOGIC XÁC ĐỊNH TRẠNG THÁI ---
                          string badgeClass;
                          string statusText;
                          if (completedAttendanceScheduleIds.Contains(w.WorkScheduleID))
                          {
                              badgeClass = "badge-done";
                              statusText = "Đã làm";
                          }
                          else // Mặc định là "Dự kiến" vì đã lọc "Đã duyệt" ở trên
                          {
                              badgeClass = "badge-plan";
                              statusText = "Dự kiến";
                          }
                          var shiftText = string.IsNullOrWhiteSpace(w.Shift) ? "—" : w.Shift;

                          <div class="cal-note @badgeClass">
                            <div class="note-row">
                              <span class="note-shift">@shiftText</span>
                              <span class="note-status">@statusText</span>
                            </div>
                          </div>
                      }
                  }
                </div>
            }
        }

        @* Bổ sung ô trống để đủ hàng (6 hàng x 7 cột = 42 ô) *@
        @{
            // Chỉ đệm để đủ cột của hàng cuối (0..6 ô)
int totalCells = (startIsoDow - 1) + daysInMonth;
int pad = (7 - (totalCells % 7)) % 7; // nếu đã tròn hàng thì pad = 0
for (int i = 0; i < pad; i++)
{
    <div class="cal-cell cal-empty"></div>
}

        }
      </div>
    </div>

    <div class="calendar-legend print-visible">
      <span class="legend-box badge-done"></span> Đã làm
      <span class="legend-box badge-plan"></span> Dự kiến
      <span class="legend-box legend-today"></span> Hôm nay
    </div>
  </div>

  <div class="card-footer text-muted small">
    Tổng số ca: @Model.Items.Count
    
  </div>
</div>

@* ==== CHECK-IN / CHECK-OUT SECTION ==== *@
@if (!string.IsNullOrEmpty(employeeId))
{
    @if (TempData["ok"] != null && !Context.Request.Query.ContainsKey("ok"))
{
    <div class="alert alert-success alert-dismissible fade show mt-3 text-center" role="alert">
        <i class="fas fa-check-circle me-2"></i>@TempData["ok"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}


    var hasCheckIn = todayCheckIn != null;
    var hasCheckOut = todayCheckIn?.CheckOutTime != null;
    var hasWorkSchedule = todaySchedules != null && todaySchedules.Any();

    <div class="card shadow-sm mb-3 print-hidden attendance-card">
        <div class="card-header attendance-header">
            <h5 class="mb-0">
                <i class="fas fa-clock"></i> Check-in/Check-out hôm nay
            </h5>
        </div>
        <div class="card-body attendance-body">
            @if (!hasWorkSchedule)
            {
                <div class="alert alert-warning d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                    <div>
                        <strong>Hôm nay bạn không có ca làm việc.</strong><br />
                        <small class="text-muted">Vui lòng liên hệ quản lý để được phân ca.</small>
                    </div>
                </div>
            }
            else
            {
                var firstSchedule = todaySchedules.First();
                var shiftTimeDisplay = start.Services.ShiftTimeHelper.GetShiftTimeDisplay(firstSchedule.Shift);

                if (hasCheckIn && hasCheckOut)
                {
                    <div class="alert alert-success">
                        <i class="fas fa-check-double"></i> 
                        <strong>Đã hoàn thành ca làm việc</strong><br />
                        <small>
                            Check-in: @todayCheckIn.CheckInTime.ToString("HH:mm:ss") –
                            Check-out: @todayCheckIn.CheckOutTime?.ToString("HH:mm:ss")
                        </small>
                    </div>
                }
                else if (hasCheckIn && !hasCheckOut)
                {
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle"></i> 
                            Đã check-in lúc <strong>@todayCheckIn.CheckInTime.ToString("HH:mm:ss")</strong>
                        </div>
                        <button class="btn btn-checkout btn-sm"
        onclick="openCheckModal(false, @firstSchedule.WorkScheduleID)">
    <i class="fas fa-sign-out-alt me-1"></i> Check-out
</button>


                    </div>
                }
                else
{
    <div class="checkin-section text-center">
        <p class="text-muted mb-2">
            <i class="fas fa-info-circle"></i>
            Ca hôm nay: <strong>@firstSchedule.Shift</strong> 
            (<span>@shiftTimeDisplay</span>)
        </p>
        <button class="btn btn-primary btn-lg w-100"
                onclick="openCheckModal(true, @firstSchedule.WorkScheduleID)">
            <i class="fas fa-sign-in-alt"></i> Check-in cho ca @firstSchedule.Shift
        </button>
    </div>
}

            }
        </div>
    </div>
}

@* ==== MODAL CONTAINER (nơi server load modal vào) ==== *@
<div id="checkModalContainer"></div>

<script>
async function openCheckModal(isCheckIn, workScheduleId) {
    try {
        console.log('openCheckModal called with workScheduleId:', workScheduleId);
        const url = isCheckIn ? `/Employee/CheckIn/${workScheduleId ?? ''}` : `/Employee/CheckOut`;
        console.log('Fetching URL:', url);
        const response = await fetch(url);
        const html = await response.text();
        console.log('Full HTML response length:', html.length);
        console.log('HTML received (first 500 chars):', html.substring(0, 500));
        
        // Kiểm tra xem có video element không
        if (!html.includes('id="video"')) {
            console.error('❌ Video element NOT FOUND in HTML response!');
            console.log('Full HTML:', html);
        } else {
            console.log('✅ Video element found in HTML');
        }

        let container = document.getElementById('checkModalContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'checkModalContainer';
            document.body.appendChild(container);
        }
        container.innerHTML = html;
        console.log('HTML inserted');

        // Tìm và thực thi script nếu có
        const scripts = container.querySelectorAll('script');
        console.log('Found scripts:', scripts.length);
        scripts.forEach((oldScript, index) => {
            console.log(`Executing script ${index}:`, oldScript.innerHTML.substring(0, 100));
            const newScript = document.createElement('script');
            Array.from(oldScript.attributes).forEach(attr => {
                newScript.setAttribute(attr.name, attr.value);
            });
            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
            oldScript.parentNode.replaceChild(newScript, oldScript);
        });

        const modalElement = document.getElementById('checkInModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            
            // Đăng ký sự kiện camera khi modal được hiển thị
            // Khi modal hiển thị xong → đợi 300ms rồi bật camera (tránh đơ)
modalElement.addEventListener('shown.bs.modal', function () {
    setTimeout(() => {
        if (window.modalCamera && window.modalCamera.init) {
            window.modalCamera.init();
        }
    }, 300);
}, { once: true });
            
            // Cleanup khi modal đóng
            modalElement.addEventListener('hidden.bs.modal', function () {
                if (window.modalCamera && window.modalCamera.stop) {
                    window.modalCamera.stop();
                }
            }, { once: true });
            
            modal.show();
            console.log('Modal show() called');
        } else {
            console.error('Modal element not found');
        }
    } catch (err) {
        console.error('Error loading modal:', err);
        alert('Lỗi khi tải giao diện Check-in/Check-out.');
    }
}
</script>
