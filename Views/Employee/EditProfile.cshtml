@using start.Models
@using System.Security.Claims
@model EditEmployeeProfile
@{
    // Ki·ªÉm tra role ƒë·ªÉ d√πng layout ph√π h·ª£p
    // ∆Øu ti√™n: ViewBag.CurrentRole (t·ª´ controller) -> Claims -> Employee object
    var roleFromViewBag = ViewBag.CurrentRole as string;
    var roleFromClaims = User?.FindFirst("Role")?.Value ?? User?.FindFirst("RoleID")?.Value;
    var emp = ViewBag.Employee as Employee ?? ViewData["Employee"] as Employee;
    var roleFromEmployee = emp?.RoleID;
    
    var roleRaw = roleFromViewBag ?? roleFromClaims ?? roleFromEmployee;
    var role = !string.IsNullOrWhiteSpace(roleRaw) ? roleRaw.Trim().ToUpperInvariant() : "";
    
    // Ch·ªçn layout d·ª±a tr√™n role
    if (role == "MK")
    {
        Layout = "~/Views/Shared/_MarketingLayout.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/_EmployeeLayout.cshtml";
    }
    
    ViewBag.ActiveMenu = "EditProfile";
    ViewData["Title"] = "Ch·ªânh s·ª≠a th√¥ng tin c√° nh√¢n";

    // ƒê·∫£m b·∫£o emp ƒë∆∞·ª£c set
    if (emp == null)
    {
        emp = ViewBag.Employee as Employee ?? ViewData["Employee"] as Employee;
    }
    
    var avatarUrl = !string.IsNullOrWhiteSpace(emp?.AvatarUrl)
        ? emp.AvatarUrl
        : "https://res.cloudinary.com/do48qpmut/image/upload/v1761645429/uploads/tdppvgyas8bhvfs7lton.png";
}

@section Styles { <link rel="stylesheet" href="~/css/employee/editprofile.css" /> }

@if (TempData["ok"] != null){ <div class="ep-alert ep-success">@TempData["ok"]</div> }
@if (TempData["err"] != null){ <div class="ep-alert ep-error">@TempData["err"]</div> }

<nav class="tabs tabs--with-action">


  <!-- Kh·ªëi avatar: click ·∫£nh ƒë·ªÉ ch·ªçn file -->
  <form asp-controller="Employee" asp-action="UploadAvatar" method="post" enctype="multipart/form-data" class="ep-ava-wrap">
      @Html.AntiForgeryToken()
      <div class="ep-ava" id="avaClick">
        <img src="@avatarUrl" id="avatarPreview" alt="avatar">
        <div class="ep-ava-hint">ƒê·ªïi ·∫£nh</div>
      </div>
      <input type="file" name="avatar" id="avatarFile" accept="image/*" hidden />
      <button type="submit" class="btn btn-primary" id="btnUploadAvatar" style="display:none">T·∫£i l√™n</button>
  </form>
   <div class="tabs-left">
    <a class="tab active" href="#">Ch·ªânh s·ª≠a</a>
  </div>
</nav>

<div class="section">
  <form asp-controller="Employee" asp-action="Edit" method="post" class="ep-form">
    @Html.AntiForgeryToken()

    <h3 class="section-title">TH√îNG TIN C∆† B·∫¢N</h3>
    <div class="grid">
      <div class="field">
        <label>Ng√†y sinh</label>
        <input asp-for="DateOfBirth" type="date" />
        <span asp-validation-for="DateOfBirth" class="vld"></span>
      </div>
      <div class="field">
        <label>Gi·ªõi t√≠nh</label>
        <input asp-for="Gender" />
        <span asp-validation-for="Gender" class="vld"></span>
      </div>
      <div class="field">
        <label>Qu·ªëc t·ªãch</label>
        <input asp-for="Nationality" />
        <span asp-validation-for="Nationality" class="vld"></span>
      </div>
      <div class="field">
        <label>D√¢n t·ªôc</label>
        <input asp-for="Ethnicity" />
        <span asp-validation-for="Ethnicity" class="vld"></span>
      </div>
    </div>

    <h3 class="section-title">TH√îNG TIN LI√äN H·ªÜ</h3>
    <div class="grid">
      <div class="field">
        <label>ƒêi·ªán tho·∫°i di ƒë·ªông</label>
        <input asp-for="PhoneNumber" />
        <span asp-validation-for="PhoneNumber" class="vld"></span>
      </div>
      <div class="field">
        <label>Email c√° nh√¢n</label>
        <input asp-for="Email" type="email" />
        <span asp-validation-for="Email" class="vld"></span>
      </div>
      <div class="field">
        <label>SƒêT kh·∫©n c·∫•p 1</label>
        <input asp-for="EmergencyPhone1" />
        <span asp-validation-for="EmergencyPhone1" class="vld"></span>
      </div>
      <div class="field">
        <label>SƒêT kh·∫©n c·∫•p 2</label>
        <input asp-for="EmergencyPhone2" />
        <span asp-validation-for="EmergencyPhone2" class="vld"></span>
      </div>
    </div>

    <h3 class="section-title">·∫¢NH KHU√îN M·∫∂T CHO CHECK-IN</h3>

<div class="ep-face-wrap mb-4">
    @if (emp != null && (emp.RoleID == "EM" || emp.RoleID == "SL" || emp.RoleID == "SH"))
    {
        if (string.IsNullOrEmpty(emp.AvatarUrl))
        {
            <div class="alert alert-warning d-flex align-items-center" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <div>
                    <strong>Y√™u c·∫ßu c·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán!</strong><br />
                    Nh√¢n vi√™n v√† qu·∫£n l√Ω ca c·∫ßn c√≥ ·∫£nh ƒë·∫°i di·ªán ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng <strong>Check-in/Check-out b·∫±ng khu√¥n m·∫∑t</strong>.
                    Vui l√≤ng ch·ªçn ·∫£nh r√µ m·∫∑t ·ªü ph·∫ßn ‚Äúƒê·ªïi ·∫£nh ƒë·∫°i di·ªán‚Äù ph√≠a tr√™n.
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-success d-flex align-items-center" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <div>·∫¢nh ƒë·∫°i di·ªán c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω ƒë·ªÉ nh·∫≠n di·ªán khu√¥n m·∫∑t khi Check-in/Check-out.</div>
            </div>

            <div class="d-flex align-items-start gap-3">
                <img src="@emp.AvatarUrl" alt="·∫¢nh khu√¥n m·∫∑t" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;" />
                <div class="text-muted small">
                    
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info d-flex align-items-center" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <div>T√≠nh nƒÉng nh·∫≠n di·ªán khu√¥n m·∫∑t ch·ªâ √°p d·ª•ng cho <strong>nh√¢n vi√™n (EM)</strong> v√† <strong>qu·∫£n l√Ω ca (SL)</strong>.</div>
        </div>
    }
</div>


    <h3 class="section-title">ƒê·ªîI M·∫¨T KH·∫®U</h3>
<button type="button" class="btn btn-ghost btn-sm" id="btnTogglePwd">+ T√¥i mu·ªën ƒë·ªïi m·∫≠t kh·∫©u</button>

<div id="pwdBlock" style="display:none;margin-top:10px">
  <div class="grid">
    <div class="field">
      <label>M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
      <input asp-for="CurrentPassword" type="password" autocomplete="current-password" />
      <span asp-validation-for="CurrentPassword" class="vld"></span>
    </div>

    <div class="field">
      <label>M·∫≠t kh·∫©u m·ªõi</label>
      <input asp-for="NewPassword" type="password" autocomplete="new-password" />
      <span asp-validation-for="NewPassword" class="vld"></span>
    </div>

    <div class="field">
      <label>X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
      <input asp-for="ConfirmNewPassword" type="password" autocomplete="new-password" />
      <span asp-validation-for="ConfirmNewPassword" class="vld"></span>
    </div>
  </div>

</div>
<div asp-validation-summary="All" class="vld vld-sum"></div>

<div class="actions">
  <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
  <a asp-controller="Employee" asp-action="Profile" class="btn btn-ghost">Hu·ª∑</a>
</div>
</form>  <!-- üî• ƒê√≥ng form ·ªü ƒë√¢y, sau actions -->



@section Scripts {
  <partial name="_ValidationScriptsPartial" />
  <script>
    // Toggle block ƒë·ªïi m·∫≠t kh·∫©u
    (function(){
      const btn = document.getElementById('btnTogglePwd');
      const blk = document.getElementById('pwdBlock');
      let open = false;
      btn?.addEventListener('click', function(){
        open = !open;
        blk.style.display = open ? 'block' : 'none';
        btn.textContent = open ? '- ·∫®n ph·∫ßn ƒë·ªïi m·∫≠t kh·∫©u' : '+ T√¥i mu·ªën ƒë·ªïi m·∫≠t kh·∫©u';
      });
    })();
    // Avatar: click ·∫£nh ho·∫∑c n√∫t ƒë·ªÉ ch·ªçn file, xem tr∆∞·ªõc v√† hi·ªán n√∫t t·∫£i l√™n
    (function(){
      const pickBtn = document.getElementById('btnPickAvatar');
      const imgWrap = document.getElementById('avaClick');
      const input = document.getElementById('avatarFile');
      const preview = document.getElementById('avatarPreview');
      const uploadBtn = document.getElementById('btnUploadAvatar');
      function choose(){ input?.click(); }
      pickBtn?.addEventListener('click', choose);
      imgWrap?.addEventListener('click', choose);
      input?.addEventListener('change', function(){
        if (this.files && this.files[0]) {
          const url = URL.createObjectURL(this.files[0]);
          preview.src = url;
          uploadBtn.style.display = 'inline-flex';
        }
      });
    })();

    // Upload ·∫£nh khu√¥n m·∫∑t
    (function(){
      const form = document.getElementById('faceImageForm');
      const input = document.getElementById('faceImageFile');
      const preview = document.getElementById('faceImagePreview');
      const messageDiv = document.getElementById('faceImageMessage');
      
      // Preview ·∫£nh khi ch·ªçn
      input?.addEventListener('change', function(){
        if (this.files && this.files[0]) {
          const url = URL.createObjectURL(this.files[0]);
            if (preview) {
            preview.src = url;
            preview.style.display = 'block';
          } else {
            // N·∫øu ch∆∞a c√≥ preview, t·∫°o m·ªõi
            const img = document.createElement('img');
            img.id = 'faceImagePreview';
            img.src = url;
            img.alt = 'Face Image';
            img.style.cssText = 'width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;';
            const container = input.closest('.d-flex').querySelector('div:first-child');
            if (container) {
              container.innerHTML = '';
              container.appendChild(img);
            }
          }
        }
      });

      // Submit form
      form?.addEventListener('submit', async function(e){
        e.preventDefault();
        const formData = new FormData(form);
        const uploadBtn = document.getElementById('btnUploadFaceImage');
        const originalText = uploadBtn.innerHTML;
        
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang t·∫£i...';
        messageDiv.innerHTML = '';
        
        try {
          const response = await fetch('/Employee/UploadFaceImage', {
            method: 'POST',
            body: formData,
            headers: {
              'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            }
          });
          
          const result = await response.json();
          
          if (result.success) {
            messageDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> ' + result.message + '</div>';
            setTimeout(() => location.reload(), 1500);
          } else {
            messageDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> ' + result.message + '</div>';
          }
        } catch (error) {
          messageDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.</div>';
        } finally {
          uploadBtn.disabled = false;
          uploadBtn.innerHTML = originalText;
        }
      });
    })();
  </script>
}