@model start.Models.Cart
@{
    ViewData["Title"] = "Thanh to√°n";
}
<link rel="stylesheet" href="/css/order.css" />

<div class="page-header d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0 d-flex align-items-center gap-2">
        <span class="me-2">üßã</span>
        <span>Thanh to√°n</span>
    </h2>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang ch·ªß</a></li>
            <li class="breadcrumb-item"><a asp-controller="Product" asp-action="Product">Th·ª±c ƒë∆°n</a></li>
            <li class="breadcrumb-item active" aria-current="page">Thanh to√°n</li>
        </ol>
    </nav>
</div>

@if (Model?.CartDetails == null || !Model.CartDetails.Any())
{
    <div class="empty-cart text-center p-5 my-5">
        <i class="fas fa-box-open fa-3x text-brown mb-3 bounce-icon"></i>
        <h4 class="mb-2 text-brown">Gi·ªè h√†ng tr·ªëng</h4>
        <p class="text-muted mb-4">B·∫°n ch∆∞a th√™m s·∫£n ph·∫©m n√†o v√†o gi·ªè. H√£y quay l·∫°i menu ƒë·ªÉ ch·ªçn m√≥n nh√©!</p>
        <a asp-controller="Product" asp-action="Product" class="btn btn-brown">
            <i class="fas fa-arrow-left me-2"></i> Quay v·ªÅ menu
        </a>
    </div>
}

else
{
    <div class="container">
        <!-- Progress Steps -->
        <div class="checkout-steps mb-4">
            <div class="step active"><span class="step-index">1</span> Th√¥ng tin</div>
            <div class="step"><span class="step-index">2</span> Thanh to√°n</div>
            <div class="step"><span class="step-index">3</span> Ho√†n t·∫•t</div>
        </div>

        <div class="row">
            <!-- C·ªôt tr√°i -->
            <div class="col-md-8">
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="orderTab">
                    <li class="nav-item">
                        <a class="nav-link active d-flex align-items-center gap-2" data-bs-toggle="tab" href="#deliveryTab">
                            <i class="fa-solid fa-truck"></i>
                            <span>Giao h√†ng t·∫≠n n∆°i</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex align-items-center gap-2" data-bs-toggle="tab" href="#pickupTab">
                            <i class="fa-solid fa-store"></i>
                            <span>Nh·∫≠n t·∫°i c·ª≠a h√†ng</span>
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Tab: Giao h√†ng t·∫≠n n∆°i -->
                    <div class="tab-pane fade show active" id="deliveryTab">
                        <form id="deliveryForm" class="p-3 border rounded bg-light shadow-sm">
                            <input type="hidden" name="BranchID" id="branchIdInput" />

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fa-regular fa-user me-1"></i>H·ªç t√™n</label>
                                    <input type="text" name="Name" id="nameInput" class="form-control input-focus"
                                        required />
                                    <small id="nameError" class="text-danger d-none"></small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><i class="fa-solid fa-phone me-1"></i>S·ªë ƒëi·ªán tho·∫°i</label>
                                    <input type="text" name="Phone" id="phoneInput" class="form-control input-focus"
                                        required />
                                    <small id="phoneError" class="text-danger d-none"></small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><i class="fa-solid fa-location-dot me-1"></i>ƒê·ªãa ch·ªâ giao
                                    h√†ng</label>
                                <div class="input-group">
                                    <input type="text" name="Address" id="addressInput" class="form-control input-focus"
                                        required />
                                    <button type="button" id="btnLocation"
                                        class="btn btn-outline-primary d-flex align-items-center gap-2">
                                        <i class="fa-solid fa-crosshairs"></i>
                                        <span>V·ªã tr√≠ c·ªßa t√¥i</span>
                                    </button>
                                </div>
                                <small id="addressError" class="text-danger d-none"></small>
                                <div class="nearest-branch-box p-3 rounded mt-2 bg-warning bg-opacity-10 border">
                                    <label class="form-label fw-bold">Chi nh√°nh g·∫ßn nh·∫•t</label>
                                    <input type="text" id="nearestBranchInput" class="form-control near" readonly />
                                    <small class="text-muted">H·ªá th·ªëng t·ª± ƒë·ªông ch·ªçn chi nh√°nh g·∫ßn nh·∫•t</small>
                                    <small id="branchWarning" class="text-danger d-block mt-1"
                                        style="display:none;"></small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><i class="fa-regular fa-note-sticky me-1"></i>Ghi ch√∫</label>
                                <textarea name="Note" class="form-control input-focus" id="detailAddress"
                                placeholder="Ghi ch√∫ ƒë·ªãa ch·ªâ chi ti·∫øt"></textarea>
                                <small id="detailError" class="text-danger d-none"></small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><i class="fa-regular fa-credit-card me-1"></i>Ph∆∞∆°ng th·ª©c thanh
                                    to√°n</label><br />
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="Payment" value="COD">
                                    <label class="form-check-label">Thanh to√°n khi nh·∫≠n h√†ng</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="Payment" value="Momo">
                                    <label class="form-check-label">Thanh to√°n qua Momo</label>
                                </div>
                                <small id="paymentError" class="text-danger d-none"></small>
                            </div>
                        </form>
                    </div>

                    <!-- Tab: Nh·∫≠n t·∫°i c·ª≠a h√†ng -->
                    <div class="tab-pane fade" id="pickupTab">
                        <form id="pickupForm" class="p-3 border rounded bg-light shadow-sm">
                            <div class="mb-3">
                                <label class="form-label"><i class="fa-solid fa-store me-1"></i>Ch·ªçn c·ª≠a h√†ng</label>
                                <select id="branchSelect" name="BranchID" class="form-select input-focus" required>
                                    <option value="">-- Ch·ªçn chi nh√°nh --</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><i class="fa-regular fa-user me-1"></i>H·ªç t√™n</label>
                                <input type="text" name="Name" id="pickupName" class="form-control input-focus" required />
                                <small id="pickupNameError" class="text-danger d-none"></small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><i class="fa-solid fa-phone me-1"></i>S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="text" name="Phone" id="pickupPhone" class="form-control input-focus" required />
                                <small id="pickupPhoneError" class="text-danger d-none"></small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- C·ªôt ph·∫£i: Th√¥ng tin ƒë∆°n h√†ng -->
            <div class="col-md-4">
                <div class="order-summary shadow-lg p-3 rounded sticky-md-top" style="top: 88px;">
                    <h5 class="cart-title mb-3">Th√¥ng tin ƒë∆°n h√†ng</h5>

                    <ul class="cart-list">
                        @foreach (var item in Model.CartDetails)
                        {
                            <li class="cart-item d-flex align-items-center mb-3">
                                <div class="position-relative cart-img me-2">
                                    <img src="@item.Product?.Image_Url" alt="@item.Product?.ProductName" />
                                    <span class="qty-badge">@item.Quantity</span>
                                </div>
                                <div class="cart-info flex-fill">
                                    <b>@item.Product?.ProductName</b>
                                    <small class="text-muted d-block">
                                        Size: @item.ProductSize?.Size
                                    </small>
                                </div>
                                <div class="cart-price text-end fw-bold">
                                    @item.Total.ToString("#,0") ƒë
                                </div>
                            </li>
                        }
                    </ul>

                    <!-- Khuy·∫øn m√£i -->
                    <div class="promo-code mt-3">
                        <label for="promoCode" class="form-label">M√£ khuy·∫øn m√£i</label>
                        <div class="input-group">
                            <input type="text" id="promoCode" class="form-control" placeholder="Nh·∫≠p m√£" />
                            <button type="button" id="btnApplyPromo" class="btn btn-outline-success"><i
                                    class="fa-solid fa-badge-percent me-1"></i>√Åp d·ª•ng</button>
                        </div>
                        <div id="promoMessage" class="mt-2 small text-success d-none"></div>
                    </div>


                    <div class="cart-fee d-flex justify-content-between align-items-center mt-2">
                        <span class="text-muted">Ph√≠ v·∫≠n chuy·ªÉn</span>
                        <span id="shippingFee">0 ƒë</span>
                    </div>

                    <div class="divider my-2"></div>

                    <div class="cart-total d-flex justify-content-between fw-bold">
                        <span>T·ªïng c·ªông</span>
                        <span id="grandTotal" data-items-total="@Model.CartDetails.Sum(cd => cd.Total)">
                            @Model.CartDetails.Sum(cd => cd.Total).ToString("#,0") ƒë
                        </span>

                    </div>

                    <button id="btnSubmitOrder" class="btn-place-order mt-3">ƒê·∫∂T H√ÄNG</button>
                    <a asp-controller="Product" asp-action="Product" class="btn-continue">‚¨Ö Ti·∫øp t·ª•c mua h√†ng</a>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        let userPos = null;
        let branches = [];
        const shippingRate = 5000;

        const productTotal = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.CartDetails.Sum(cd => cd.Total)));


        // ===== Load danh s√°ch chi nh√°nh =====
        async function loadBranches() {
            try {
                const res = await fetch('/Branch/GetAll');
                const data = await res.json();
                branches = data;
                // Fill dropdown cho tab pickup
                const branchSelect = document.getElementById("branchSelect");
                branchSelect.innerHTML = '<option value="">-- Ch·ªçn chi nh√°nh --</option>';
                data.forEach(b => {
                    branchSelect.innerHTML += `<option value="${b.branchID}">${b.name} - ${b.address}</option>`;
                });
            } catch (e) { console.error("Load branches error:", e); }
        }
        loadBranches();

        // ===== Button v·ªã tr√≠ c·ªßa t√¥i =====
        document.getElementById("btnLocation").addEventListener("click", () => {
            if (!navigator.geolocation) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.");

            navigator.geolocation.getCurrentPosition(async pos => {
                userPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };

                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userPos.lat}&lon=${userPos.lon}&zoom=18&addressdetails=1`);
                    const data = await res.json();
                    const addr = data?.display_name || `${userPos.lat}, ${userPos.lon}`;
                    document.getElementById("addressInput").value = addr;
                } catch (e) { console.error("Reverse geocode error:", e); }

                if (branches.length) {
                    branches.forEach(b => {
                        b.distance = calcDistance(userPos.lat, userPos.lon, b.latitude, b.longitude);
                    });
                    branches.sort((a, b) => a.distance - b.distance);
                    const nearest = branches[0];
                    document.getElementById("branchIdInput").value = nearest.branchID;

                    // Show nearest branch info
                    document.getElementById("nearestBranchInput").value =
                        `${nearest.name} - ${nearest.address} - ${nearest.distance.toFixed(2)} km`;

                    // Warning check
                    const warningEl = document.getElementById("branchWarning");
                    if (nearest.distance > 12) {
                        warningEl.textContent = "Kho·∫£ng c√°ch t·ªõi chi nh√°nh g·∫ßn nh·∫•t qu√° xa (> 12 km). Vui l√≤ng ch·ªçn Nh·∫≠n t·∫°i c·ª≠a h√†ng.";
                        warningEl.style.display = "block";
                        document.getElementById("btnSubmitOrder").disabled = true;
                    } else {
                        warningEl.style.display = "none";
                        document.getElementById("btnSubmitOrder").disabled = false;
                    }
                    // ===== T√çNH PH√ç SHIP =====
                    const fee = Math.round(nearest.distance * shippingRate);
                    document.getElementById("shippingFee").innerText = fee.toLocaleString() + " ƒë";

                    const grand = productTotal + fee;
                    document.getElementById("grandTotal").innerText = grand.toLocaleString() + " ƒë";
                }
            }, err => alert("‚ùå Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠: " + err.message));
        });

        // ===== T√≠nh kho·∫£ng c√°ch Haversine =====
        function calcDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) *
                Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

       

            let form;
 // ===== Submit Order =====
        document.getElementById("btnSubmitOrder").addEventListener("click", async () => {

            ["nameError", "phoneError", "addressError", "paymentError", "detailError","pickupNameError","pickupPhoneError"].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add("d-none");
            });

            const isDelivery = document.querySelector("#deliveryTab").classList.contains("active");
            let valid = true;

            if (isDelivery) {
                // validate form Giao h√†ng
                const name = document.getElementById("nameInput").value.trim();
                const phone = document.getElementById("phoneInput").value.trim();
                const address = document.getElementById("addressInput").value.trim();
                const detail = document.getElementById("detailAddress").value.trim();
                const payment = document.querySelector("input[name='Payment']:checked");

                if (!name) {
                    document.getElementById("nameError").textContent = "Vui l√≤ng nh·∫≠p h·ªç t√™n.";
                    document.getElementById("nameError").classList.remove("d-none");
                    valid = false;
                }

                if (!/^[0-9]{9,11}$/.test(phone)) {
                    document.getElementById("phoneError").textContent = "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá.";
                    document.getElementById("phoneError").classList.remove("d-none");
                    valid = false;
                }

                if (!address) {
                    document.getElementById("addressError").textContent = "Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng.";
                    document.getElementById("addressError").classList.remove("d-none");
                    valid = false;
                }

                if (!detail) {
                    document.getElementById("detailError").textContent = "Vui l√≤ng nh·∫≠p chi ti·∫øt ƒë·ªãa ch·ªâ giao h√†ng.";
                    document.getElementById("detailError").classList.remove("d-none");
                    valid = false;
                }
                if (!payment) {
                    document.getElementById("paymentError").textContent = "Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n.";
                    document.getElementById("paymentError").classList.remove("d-none");
                    valid = false;
                }
            } else {
                // validate form Nh·∫≠n t·∫°i c·ª≠a h√†ng
                const name = document.getElementById("pickupName").value.trim();
                const phone = document.getElementById("pickupPhone").value.trim();

                if (!name) {
                    document.getElementById("pickupNameError").textContent = "Vui l√≤ng nh·∫≠p h·ªç t√™n.";
                    document.getElementById("pickupNameError").classList.remove("d-none");
                    valid = false;
                }

                if (!/^[0-9]{9,11}$/.test(phone)) {
                    document.getElementById("pickupPhoneError").textContent = "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá.";
                    document.getElementById("pickupPhoneError").classList.remove("d-none");
                    valid = false;
                }
            }

            if (!valid) return;
            // X√°c ƒë·ªãnh form n√†o ƒëang active
            if (document.querySelector("#deliveryTab").classList.contains("active")) {

                // N·∫øu ƒëang ch·ªçn giao h√†ng m√† branch > 12km th√¨ ch·∫∑n
                const nearestBranchText = document.getElementById("nearestBranchInput").value;
                if (nearestBranchText.includes("km")) {
                    const km = parseFloat(nearestBranchText.split("km")[0].split("-").pop());
                    if (km > 12) {
                        alert("Kh√¥ng th·ªÉ giao h√†ng v√¨ kho·∫£ng c√°ch qu√° xa (> 12km). H√£y ch·ªçn Nh·∫≠n t·∫°i c·ª≠a h√†ng.");
                        return;
                    }
                }
                form = document.getElementById("deliveryForm");
            } else {
                form = document.getElementById("pickupForm");
            }

            let formData = new FormData(form);

            try {
                const res = await fetch('/Order/CreateOrder', {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) {
                    throw new Error("Server error: " + res.status);
                }

                const data = await res.json();

                if (data.success) {
                    // ‚úÖ Redirect sang trang OrderConfirmed k√®m OrderID
                    window.location.href = `/Order/Confirmed/${data.orderId}`;
                } else {
                    alert("‚ùå " + data.message);
                }
            } catch (err) {
                console.error("Order error:", err);
                alert("‚ùå ƒê·∫∑t h√†ng th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.");
            }
        });

    </script>

    <script>
        function setStep(stepIndex) {
            const steps = document.querySelectorAll(".checkout-steps .step");
            steps.forEach((s, i) => {
                s.classList.toggle("active", i === stepIndex);
            });
        }

        // ===== Validate v√† nh·∫£y Step =====
        function checkAndGoStep2(form) {
            if (form.checkValidity()) {
                const paymentSelected = form.querySelector("input[name='Payment']:checked");
                if (paymentSelected) {
                    setStep(1); // Step 2: Ch·ªçn thanh to√°n
                }
            }
        }

        // ====== Input blur ======
        document.querySelectorAll("#deliveryForm input, #pickupForm input").forEach(inp => {
            inp.addEventListener("blur", () => {
                const form = inp.closest("form");
                checkAndGoStep2(form);
            });
        });

        // ====== Radio Payment Change ======
        document.querySelectorAll("input[name='Payment']").forEach(radio => {
            radio.addEventListener("change", () => {
                const form = radio.closest("form");
                checkAndGoStep2(form);
            });
        });

        // ====== √âp check khi page load (COD m·∫∑c ƒë·ªãnh) ======
        window.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("deliveryForm");
            checkAndGoStep2(form);
        });

        // ====== Promo Code Logic ======
        document.addEventListener("DOMContentLoaded", () => {
            const grandTotalEl = document.getElementById("grandTotal");
            const shippingEl = document.getElementById("shippingFee");
            const promoInput = document.getElementById("promoCode");
            const promoMsg = document.getElementById("promoMessage");
            const btnApplyPromo = document.getElementById("btnApplyPromo");

            const originalItemsTotal = parseInt(grandTotalEl.dataset.itemsTotal) || 0;

            function parseVND(str) {
                if (!str) return 0;
                return parseInt(str.replace(/[^\d]/g, "")) || 0;
            }

            function updateGrandTotal(discountPercent = 0) {
                const shippingFee = parseVND(shippingEl.innerText);
                let total = originalItemsTotal + shippingFee;
                if (discountPercent > 0) total = Math.round(total * (1 - discountPercent / 100));
                grandTotalEl.innerText = total.toLocaleString("vi-VN") + " ƒë";
            }

            updateGrandTotal();

            btnApplyPromo.addEventListener("click", () => {
                const code = promoInput.value.trim().toUpperCase();

                if (code === "SALE10") {
                    updateGrandTotal(10);
                    promoMsg.classList.remove("d-none", "text-danger");
                    promoMsg.classList.add("text-success");
                    promoMsg.innerText = "‚úÖ Gi·∫£m 10% ƒë√£ √°p d·ª•ng";
                } else if (code === "") {
                    updateGrandTotal();
                    promoMsg.classList.add("d-none");
                } else {
                    updateGrandTotal();
                    promoMsg.classList.remove("d-none", "text-success");
                    promoMsg.classList.add("text-danger");
                    promoMsg.innerText = "‚ùå M√£ kh√¥ng h·ª£p l·ªá";
                }
            });
        });

    </script>

}