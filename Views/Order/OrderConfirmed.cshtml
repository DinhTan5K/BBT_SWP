@model start.Models.Order
@{
    ViewData["Title"] = "Order Confirmed";
    ViewData["Step"] = 3;
}

<partial name="_CheckoutSteps" view-data="ViewData" />

<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@300;400;500;700&display=swap"
    rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

<link rel="stylesheet" href="/css/Order/order.css">
<link rel="stylesheet" href="/css/Order/orderconfirmed.css">


<div class="order-confirmed-page container py-5">

    <div class="order-header text-center pb-4">
        <div class="icon-circle mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M20.285 6.709a1 1 0 0 0-1.414-1.418l-9.192 9.192-4.192-4.192a1 1 0 1 0-1.414 1.414l4.899 4.899a1 1 0 0 0 1.414 0l9.899-9.89z" />
            </svg>
        </div>
        <h2 class="section-title">ĐƠN HÀNG ĐÃ ĐẶT THÀNH CÔNG</h2>
        <p class="lead-text text-muted">Cảm ơn bạn đã tin tưởng lựa chọn chúng tôi!</p>
        <p class="order-code h4 mt-3">Mã đơn hàng: #@Model.OrderCode</p>
    </div>

    <div class="row gx-4">

        <div class="col-lg-6">
            <div class="detail-card mb-4">
                <div class="card-header-custom">
                    <h5 class="mb-0">
                        <i class="fas fa-box-open me-2"></i> Chi tiết các Sản Phẩm
                    </h5>
                </div>
                <ul class="list-group list-group-flush">
                    @foreach (var item in Model.OrderDetails)
                    {
                        <li class="list-group-item item-detail-row">
                            <div class="d-flex align-items-center">
                                <img src="@item.Product.Image_Url" class="item-thumbnail me-3"
                                    alt="@item.Product.ProductName" />
                                <div class="flex-grow-1">
                                    <b class="d-block product-name">@item.Product.ProductName</b>
                                    <small class="text-muted product-variant">Size: @item.ProductSize?.Size</small>
                                </div>
                                <div class="text-end">
                                    <span class="d-block item-price">@item.Total.ToString("#,0") đ</span>
                                    <small class="text-muted item-quantity">SL: @item.Quantity</small>
                                </div>
                            </div>
                        </li>
                    }
                </ul>
            </div>

            <div class="alert custom-alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i> Đơn hàng đang ở trạng thái **@Model.Status**. Vui lòng nhấn
                "Theo Dõi Đơn Hàng" để xem cập nhật mới nhất.
            </div>
        </div>

        <div class="col-lg-6">

            <div class="summary-card mb-4 p-3">
                <h5 class="pb-2 border-bottom-custom"><i class="fas fa-file-invoice-dollar me-1"></i> Tóm Tắt Thanh Toán
                </h5>

                @{
                    var itemsTotal = Model.OrderDetails.Sum(d => d.Total);
                    var codes = (Model.PromoCode ?? string.Empty)
                    .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                    .Select(c => c.ToUpper())
                    .ToList();
                    var shippingCodeTokens = new[] { "FREESHIP", "SHIP" };
                    var itemCodes = codes.Where(c => !shippingCodeTokens.Any(t => c.Contains(t))).ToList();
                    var shippingCodes = codes.Where(c => shippingCodeTokens.Any(t => c.Contains(t))).ToList();

                    var hasFreeShip = codes.Any(c => c.Contains("FREESHIP"));
                    var effectiveShipping = hasFreeShip ? 0m : Model.ShippingFee; // Model.ShippingFee is final fee

                    // Item promo discount only (%, fixed amount) – excludes shipping promos
                    var promoDiscount = (itemsTotal + effectiveShipping) - Model.Total;
                }

                <div class="summary-row"><span>Tổng tiền hàng:</span>
                    <span class="amount">@itemsTotal.ToString("#,0") đ</span>
                </div>

                <div class="summary-row"><span>Phí vận chuyển:</span>
                    <span class="amount">@Model.ShippingFee.ToString("+#,0;-#,0;0") đ</span>
                </div>

                @* We cannot derive the exact shipping discount amount without original shipping fee; show applied codes instead *@
                @if (shippingCodes.Any())
                {
                    <div class="summary-row discount-row">
                        <span>Mã giảm phí vận chuyển: @shippingCodes.FirstOrDefault()</span>
                    </div>
                }

                @if (promoDiscount > 0 && itemCodes.Any())
                {
                    <div class="summary-row discount-row">
                        <span>Mã giảm giá (@string.Join(",", itemCodes)):</span>
                        <span class="amount">@promoDiscount.ToString("-#,0") đ</span>
                    </div>
                }


                <div class="summary-row final-total mt-3 pt-3">
                    <span>Tổng Cộng Cần Thanh Toán:</span>
                    <span class="amount final-amount">@Model.Total.ToString("#,0") đ</span>
                </div>

                <p class="mt-3 small-text text-muted">
                    Phương thức thanh toán:
                    @(
                                        string.IsNullOrWhiteSpace(Model.PaymentMethod)
                                        ? "Không xác định"
                                        : (Model.PaymentMethod.Trim().ToUpper() == "COD"
                                        ? "Thanh toán khi nhận hàng (COD)"
                                        : (Model.PaymentMethod.Trim().ToUpper() == "MOMO"
                                        ? "Thanh toán qua Momo"
                                        : Model.PaymentMethod))
                                        )
                </p>
            </div>

            <div class="delivery-info-card p-3">
                <h6 class="mb-3">
                    <i class="fas fa-map-marker-alt me-2"></i> Thông tin Giao hàng
                </h6>

                <p class="mb-1">Người nhận: <span class="info-value">@Model.ReceiverName</span></p>
                <p class="mb-1">Điện thoại: <span class="info-value">@Model.ReceiverPhone</span></p>

                @if (!string.IsNullOrEmpty(Model.Address) && Model.Address.Contains("Nhận tại:"))
                {
                    <!-- Nếu là nhận tại cửa hàng -->
                    <p class="mb-1"><span class="info-value">@Model.Address</span></p>
                    @if (!string.IsNullOrWhiteSpace(Model.NoteOrder))
                    {
                        <p class="mb-1">Ghi chú: <span class="info-value">@Model.NoteOrder</span></p>
                    }
                }
                else
                {
                    <!-- Nếu là giao tận nơi -->
                    <p class="mb-1">Địa chỉ: <span class="info-value">@Model.Address</span></p>
                    @if (!string.IsNullOrWhiteSpace(Model.DetailAddress))
                    {
                        <p class="mb-1">Địa chỉ chi tiết: <span class="info-value">@Model.DetailAddress</span></p>
                    }
                    @if (!string.IsNullOrWhiteSpace(Model.NoteOrder))
                    {
                        <p class="mb-1">Ghi chú: <span class="info-value">@Model.NoteOrder</span></p>
                    }
                }
            </div>

        </div>
    </div>

    <div class="button-actions text-center mt-5">
        <a asp-controller="Order" asp-action="Track" asp-route-orderCode="@Model.OrderCode"
            class="btn btn-primary-custom shadow-sm px-4 me-3">
            <i class="fas fa-search me-2"></i> Theo Dõi Đơn Hàng
        </a>
        <a asp-controller="Product" asp-action="Product" class="btn btn-outline-secondary-custom px-4">
            <i class="fas fa-redo me-2"></i> Tiếp Tục Mua Sắm
        </a>
    </div>
</div>