@model start.Models.Order

@{
    ViewData["Title"] = "Tra cứu đơn hàng";
}
<link rel="stylesheet" href="/css/Order/track.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

<div class="page-content">
    <h2>Tra Cứu Đơn Hàng Của Bạn</h2>
    <p>Nhập mã đơn hàng để xem chi tiết và theo dõi hành trình.</p>

    <div class="track-form">
        <div class="input-wrapper">
            <input type="text" id="orderCode" placeholder="Ví dụ: DYGLG, XK83Q" />
        </div>
        <button id="btnTrack">
            <span class="button-text">Tra cứu</span>
        </button>
    </div>
</div>
<div id="result">
</div>

<div class="no-result" style="display: none; flex-direction: column; align-items: center; margin-top: 20px;">
    <i class="fa fa-search" style="font-size: 40px; color: #999; margin-bottom: 10px;"></i>
    <p>Không tìm thấy đơn hàng nào</p>
</div>

@section Scripts {
    <script>
        function formatCurrency(amount) {
            return parseFloat(amount).toLocaleString("vi-VN", {
                style: "currency",
                currency: "VND",
            });
        }
/**
 * Xây dựng thanh theo dõi tiến trình đơn hàng dựa trên trạng thái.
 * @@param {string} status - Trạng thái hiện tại của đơn hàng.
 * @@returns {string} Chuỗi HTML của thanh theo dõi tiến trình.
 */
function buildProgressTracker(status) {
    // 1. Cấu hình tập trung cho tất cả các bước (thêm "Chờ hoàn tiền")
    const stepConfig = {
        "Chờ xác nhận": { icon: "fa-hourglass-half" },
        "Đã xác nhận": { icon: "fa-check-circle" },
        "Đang giao": { icon: "fa-shipping-fast" },
        "Đã giao": { icon: "fa-box-open" },
        "Đã hủy": { icon: "fa-times-circle", stateClass: "failure" },
        // TRẠNG THÁI MỚI
        "Chờ hoàn tiền": { icon: "fa-history", stateClass: "pending-refund" }, 
        "Đã hoàn tiền": { icon: "fa-undo", stateClass: "special" }
    };

    // 2. Định nghĩa các luồng xử lý
    const successFlow = ["Chờ xác nhận", "Đã xác nhận", "Đang giao", "Đã giao"];
    // LUỒNG MỚI: Luồng hoàn tiền sẽ đi qua bước "Đã hủy"
    const refundFlow = ["Chờ xác nhận", "Đã hủy", "Chờ hoàn tiền", "Đã hoàn tiền"];
    
    let stepsToDisplay;

    // 3. Quyết định luồng nào sẽ được hiển thị (LOGIC MỚI)
    switch (status) {
        // Trường hợp chỉ hủy đơn, không có hoàn tiền
        case "Đã hủy":
            stepsToDisplay = ["Chờ xác nhận", "Đã hủy"];
            break;

        // Cả hai trạng thái này đều thuộc cùng một luồng hiển thị
        case "Chờ hoàn tiền":
        case "Đã hoàn tiền":
            stepsToDisplay = refundFlow;
            break;
            
        // Mặc định là luồng thành công
        default:
            stepsToDisplay = successFlow;
            break;
    }

    const activeIndex = stepsToDisplay.indexOf(status);

    if (activeIndex === -1) {
        console.error("Trạng thái không hợp lệ hoặc không nằm trong luồng xử lý:", status);
        return '<div class="error-message">Trạng thái đơn hàng không hợp lệ.</div>';
    }

    // 4. Xây dựng HTML (Không thay đổi)
    let html = '<ul class="progress-tracker">';
    stepsToDisplay.forEach((step, index) => {
        const config = stepConfig[step];
        let liClass = 'progress-step';

        if (index < activeIndex) {
            liClass += ' done';
        } else if (index === activeIndex) {
            liClass += ' active';
        }

        if (config.stateClass) {
            liClass += ` ${config.stateClass}`;
        }
        
        // Sửa lỗi nhỏ: Cần kiểm tra config tồn tại trước khi truy cập
        const iconClass = config ? config.icon : 'fa-question-circle'; 

        html += `
            <li class="${liClass}">
                <div class="progress-step-icon">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="progress-step-label">${step}</div>
            </li>
        `;
    });
    html += '</ul>';

    return html;
}
        async function trackOrder() {
            const orderCodeInput = document.getElementById("orderCode");
            let orderCode = orderCodeInput.value.trim();
            const resultDiv = document.getElementById("result");
            const trackButton = document.getElementById("btnTrack");
            const buttonText = trackButton.querySelector('.button-text');
            const noResult = document.querySelector(".no-result");

            resultDiv.innerHTML = "";

            noResult.style.display = "none";

            if (!orderCode) {
                resultDiv.innerHTML = `<p class="error-message">Vui lòng nhập mã đơn hàng để tra cứu.</p>`;
                return;
            }

            if (orderCode.startsWith("#")) {
                orderCode = orderCode.substring(1);
            }

            // Loading
            trackButton.disabled = true;
            buttonText.textContent = 'Đang tìm...';
            trackButton.insertAdjacentHTML('afterbegin', '<div class="spinner"></div>');
            resultDiv.innerHTML = `<div class="loader"></div>`;

            try {
                const response = await fetch(`/Order/TrackByCode/${orderCode}`);
                const data = await response.json();
                resultDiv.innerHTML = "";

                if (!data.success) {
                    noResult.style.display = "flex";
                } else {
                    noResult.style.display = "none";
                    const order = data.order;
                    const progressTrackerHTML = buildProgressTracker(order.status);

                    const isDelivery = order.address && !order.address.startsWith("Nhận tại:");
                    const deliveryInfo = isDelivery ? `
                                                <div class="info-row">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                    <div>
                                                        <span>Địa chỉ nhận hàng: </span>
                                                        <p>${order.address}, ${order.detailAddress || ''}</p>
                                                        <span> Địa chỉ chi tiết: </span>
                                                         <p>${order.detailAddress}</p>
                                                    </div>
                                                </div>
                                                <div class="info-row">
                                                    <i class="fas fa-credit-card"></i>
                                                    <div>
                                                        <span>Thanh toán</span>
                                                        <p>${order.paymentMethod || 'Khi nhận hàng (COD)'}</p>
                                                    </div>
                                                </div>
                                            ` : `
                                                <div class="info-row">
                                                    <i class="fas fa-store"></i>
                                                    <div>
                                                        <p>${order.address}</p>
                                                    </div>
                                                </div>
                                            `;

                    resultDiv.innerHTML = `
                                                <div class="order-card">
                                                    <div class="card-header">
                                                        <h3>Mã đơn hàng: #${order.orderCode}</h3>
                                                        <p>Đặt lúc: ${new Date(order.createdAt).toLocaleString("vi-VN")}</p>
                                                    </div>
                                                    ${progressTrackerHTML}
                                                    <div class="info-grid">
                                                        <div class="info-row">
                                                            <i class="fas fa-user"></i>
                                                            <div>
                                                                <span>Người nhận</span>
                                                                <p>${order.receiverName}</p>
                                                            </div>
                                                        </div>
                                                        <div class="info-row">
                                                            <i class="fas fa-phone"></i>
                                                            <div>
                                                                <span>Số điện thoại</span>
                                                                <p>${order.receiverPhone}</p>
                                                            </div>
                                                        </div>
                                                        ${deliveryInfo}
                                                        <div class="info-row">
                                                            <i class="fas fa-tag"></i>
                                                            <div>
                                                                <span>Khuyến mãi</span>
                                                                <p>${order.promoCode || 'Không áp dụng'}</p>
                                                            </div>
                                                        </div>
                                                        <div class="info-row">
                                                            <i class="fas fa-coins"></i>
                                                            <div>
                                                                <span>Tổng cộng</span>
                                                                <p>${formatCurrency(order.total)}</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    ${order.noteOrder ? `
                                                        <div class="info-grid" style="grid-template-columns: 1fr;">
                                                            <div class="info-row">
                                                                <i class="fas fa-sticky-note"></i>
                                                                <div>
                                                                    <span>Ghi chú</span>
                                                                    <p>${order.noteOrder}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ` : ''}
                                                    <div class="button-actions text-center mt-4">
                                                        <a href="/Order/OrderHistory" class="btn-back-order">
                                                            <i class="fas fa-arrow-left me-2"></i> Quay Lại Lịch Sử Mua Hàng
                                                        </a>
                                                    </div>
                                                </div>
                                            `;
                    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } catch (error) {
                console.error("Fetch error:", error);
                noResult.style.display = "flex";
                resultDiv.innerHTML = `<p class="error-message">Đã xảy ra lỗi khi kết nối đến máy chủ.</p>`;
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } finally {
                trackButton.disabled = false;
                trackButton.querySelector('.spinner')?.remove();
                buttonText.textContent = 'Tra cứu';
            }
        }

        // --- EVENT LISTENERS ---
        const trackButton = document.getElementById("btnTrack");
        const orderCodeInput = document.getElementById("orderCode");

        trackButton.addEventListener("click", trackOrder);
        orderCodeInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                trackOrder();
            }
        });
        
        // --- AUTO-TRACK FROM URL ---
        window.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const codeFromUrl = urlParams.get("orderCode");
            if (codeFromUrl) {
                document.getElementById("orderCode").value = codeFromUrl;
                trackOrder();
            }
        });
    </script>

}