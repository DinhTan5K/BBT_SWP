@using start.DTOs
@{
    ViewData["Title"] = "Yêu cầu đã gửi";
    Layout = "~/Views/Shared/_RegionLayout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<link rel="stylesheet" href="~/css/Region/region-dashboard.css" />

<div class="region-dashboard-container" style="margin-top:60px;">
    <h2 class="dashboard-title">Yêu cầu đã gửi</h2>

    <div style="display:flex;gap:12px;align-items:center;margin-bottom: 20px;">
        <div id="requestsFilters" class="filter-segment" role="tablist" aria-label="Filter requests"
            style="display:flex;gap:8px;">
            <button class="filter-btn active" data-cat="@((int)RequestCategory.Branch)">Chi nhánh</button>
            <button class="filter-btn" data-cat="@((int)RequestCategory.EmployeeBranch)">Quản lý chi nhánh</button>
            <button class="filter-btn" data-cat="@((int)RequestCategory.Product)">Sản phẩm</button>
            <button class="filter-btn" data-cat="@((int)RequestCategory.Category)">Danh mục</button>
        </div>

        <div style="flex:1"></div>

        <input id="reqSearch" type="text" class="form-control" placeholder="Tìm theo nội dung, người tạo..."
            style="min-width:260px; max-width: 300px;" />
    </div>

    <div id="requestsAlertPlaceholder" style="margin-bottom: 16px;"></div>

    <div id="requestsListContainer" class="requests-list">
        <div class="alert alert-info">Đang tải...</div>
    </div>
</div>

<div class="modal fade" id="requestDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết yêu cầu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="requestDetailBody">
                <div class="text-center">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="deleteRequestBtn" class="btn btn-danger">Xóa yêu cầu</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@* Page-level anti-forgery token (Giữ nguyên) *@
@Html.AntiForgeryToken()

@section Styles {
    <style>
        /* Style cho filter buttons (giống ảnh tham khảo) */
        .filter-segment .filter-btn {
            border-radius: 20px;
            padding: 6px 12px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: #fff;
            font-weight: 500;
        }

        .filter-segment .filter-btn.active {
            background: #f6e6d8;
            border-color: #e0c6a3;
            color: #5a3f2a;
            font-weight: 600;
        }

        /* CSS cho input tìm kiếm */
        #reqSearch.form-control {
            border-radius: 20px;
            padding: 6px 12px;
            height: 40px;
        }

        /* Container cho danh sách card */
        .requests-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* CSS cho mỗi Card yêu cầu */
        .request-card {
            background: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 16px 20px;
            transition: all 0.2s ease-in-out;
        }

        .request-card:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            border-color: #ddd;
        }

        /* Header của Card (chứa Title, Status, Buttons) */
        .request-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        /* Badge Loại yêu cầu (Chi nhánh, Sản phẩm...) */
        .request-card-type-badge {
            background-color: #e7f3ff;
            color: #0d6efd;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            flex-shrink: 0;
            /* Không bị co lại */
        }

        .request-card-title {
            font-size: 1.05rem;
            font-weight: 600;
            margin: 0;
            line-height: 1.4;
            /* Cho phép nội dung HTML (từ contentHtml) */
            display: inline;
        }

        .request-card-title p {
            margin: 0;
            display: inline;
        }

        /* Div trống để đẩy status/buttons sang phải */
        .request-card-header-spacer {
            flex-grow: 1;
        }

        /* Badge Trạng thái (Chờ duyệt, Đã duyệt...) */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .status-pending {
            /* Chờ duyệt */
            background: #fff8e1;
            color: #e6a23c;
        }

        .status-approved {
            /* Đã duyệt */
            background: #e6f7f0;
            color: #0d8a50;
        }

        .status-rejected {
            /* Bị từ chối */
            background: #fdf0f0;
            color: #d9534f;
        }

        /* Footer của Card (chứa thông tin meta) */
        .request-card-footer {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.85rem;
            color: #555;
            padding-left: 12px;
            /* Căn lề với title nếu badge icon không có */
        }

        .request-card-footer i {
            margin-right: 4px;
            color: #888;
        }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // config (từ Razor)
            const ENUM_BRANCH = @((int)RequestCategory.Branch);
            const ENUM_EMPBR = @((int)RequestCategory.EmployeeBranch);
            const ENUM_PRODUCT = @((int)RequestCategory.Product);
            const ENUM_CATEGORY = @((int)RequestCategory.Category);

            // Status (từ logic modal)
            const STATUS_PENDING = 0;
            const STATUS_APPROVED = 1;

            const URL_GET_LIST = '@Url.Action("GetSentRequests", "Region")';
            const URL_GET_DETAIL = '@Url.Action("GetSentRequestDetail", "Region")';
            const URL_DELETE = '@Url.Action("DeleteSentRequest", "Region")';

            // DOM references
            const categoryButtons = document.querySelectorAll('#requestsFilters .filter-btn');

            // [THAY ĐỔI] Thay thế tbody bằng listContainer
            const listContainer = document.getElementById('requestsListContainer');

            const searchInput = document.getElementById('reqSearch');
            const detailModalEl = document.getElementById('requestDetailModal');
            const detailModal = detailModalEl ? new bootstrap.Modal(detailModalEl) : null;
            const deleteRequestBtn = document.getElementById('deleteRequestBtn');
            const alertPlaceholder = document.getElementById('requestsAlertPlaceholder');

            let currentCategory = parseInt(document.querySelector('#requestsFilters .filter-btn.active').dataset.cat, 10);
            let currentList = [];

            function escapeHtml(s) { if (s === null || s === undefined) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
            function showAlert(type, text) {
                alertPlaceholder.innerHTML = `<div class="alert ${type === 'danger' ? 'alert-danger' : 'alert-success'}" role="alert">${escapeHtml(text)}</div>`;
                setTimeout(() => { alertPlaceholder.innerHTML = ''; }, 5000);
            }

            // [THÊM MỚI] Helper để lấy class CSS cho trạng thái
            function getStatusClass(statusCode) {
                if (statusCode === STATUS_PENDING) return 'status-pending';
                if (statusCode === STATUS_APPROVED) return 'status-approved';
                return 'status-rejected'; // Mặc định là rejected (bị từ chối)
            }

            // --- load list ---
            async function loadList(cat) {
                // [THAY ĐỔI] Cập nhật thông báo tải
                listContainer.innerHTML = '<div class="alert alert-info">Đang tải...</div>';
                try {
                    const res = await fetch(`${URL_GET_LIST}?category=${encodeURIComponent(cat)}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
                    if (!res.ok) throw new Error('Server trả lỗi ' + res.status);
                    const arr = await res.json();
                    currentList = Array.isArray(arr) ? arr : [];
                    renderList(currentList);
                } catch (err) {
                    console.error(err);
                    // [THAY ĐỔI] Cập nhật thông báo lỗi
                    listContainer.innerHTML = '<div class="alert alert-danger">Không lấy được dữ liệu.</div>';
                    showAlert('danger', 'Không tải được danh sách yêu cầu từ server.');
                }
            }

            // [CHỈNH SỬA] Hàm renderList để tạo Card thay vì Table Row
            function renderList(items) {
                const q = (searchInput.value || '').trim().toLowerCase();
                const filtered = (items || []).filter(i => {
                    if (!q) return true;
                    return (i.contentSummary || '').toLowerCase().includes(q) ||
                        (i.requestedBy || '').toLowerCase().includes(q) ||
                        (i.requestTypeLabel || '').toLowerCase().includes(q);
                });

                if (!filtered.length) {
                    // [THAY ĐỔI] Thông báo rỗng
                    listContainer.innerHTML = '<div class="alert alert-secondary">Không có yêu cầu phù hợp.</div>';
                    return;
                }

                // build cards
                const cards = filtered.map(i => {
                    const date = i.requestedAt ? new Date(i.requestedAt).toLocaleString() : '';
                    const status = escapeHtml(i.statusLabel || (i.status?.toString() ?? ''));
                    const reqType = escapeHtml(i.requestTypeLabel || (i.requestType?.toString() ?? '?'));
                    const statusClass = getStatusClass(i.status);
                    // for content: prefer contentHtml (safe), otherwise escaped contentSummary
                    const contentCell = i.contentHtml ? i.contentHtml : escapeHtml(i.contentSummary || '');
                    const requestedBy = escapeHtml(i.requestedBy || '...');

                    // Cấu trúc HTML của Card
                    return `
                <div class="request-card" data-id="${i.id}" data-cat="${i.category}">
                    <div class="request-card-header">
                        <span class="request-card-type-badge">${reqType}</span>
                    
                        <h5 class="request-card-title">${contentCell}</h5>
                    
                        <div class="request-card-header-spacer"></div>
                    
                        <span class="status-badge ${statusClass}">${status}</span>
                    
                        <button type="button" class="btn btn-sm btn-info btn-view" data-id="${i.id}" data-cat="${i.category}">Xem</button>
                        <button type="button" class="btn btn-sm btn-outline-danger btn-delete" data-id="${i.id}" data-cat="${i.category}">Xóa</button>
                    </div>
                
                    <div class="request-card-footer">
                        <span><i class="fa-regular fa-user"></i> ${requestedBy}</span>
                        <span><i class="fa-regular fa-clock"></i> ${date}</span>
                    </div>
                </div>`;
                });

                // [THAY ĐỔI] Đẩy HTML vào container
                listContainer.innerHTML = cards.join('');
            }

            // filter click (Giữ nguyên)
            categoryButtons.forEach(b => b.addEventListener('click', function () {
                categoryButtons.forEach(x => x.classList.remove('active'));
                this.classList.add('active');
                currentCategory = parseInt(this.dataset.cat, 10);
                loadList(currentCategory);
            }));

            // search live (Giữ nguyên)
            searchInput.addEventListener('input', () => renderList(currentList));

            // delegation: view / delete in table rows (Giữ nguyên - vẫn hoạt động vì class .btn-view, .btn-delete được giữ)
            document.addEventListener('click', async function (e) {
                const viewBtn = e.target.closest('.btn-view');
                if (viewBtn) {
                    const id = parseInt(viewBtn.dataset.id, 10);
                    const cat = parseInt(viewBtn.dataset.cat, 10);
                    await loadDetail(cat, id);
                    if (detailModal) detailModal.show();
                    return;
                }

                const delBtn = e.target.closest('.btn-delete');
                if (delBtn) {
                    const id = parseInt(delBtn.dataset.id, 10);
                    const cat = parseInt(delBtn.dataset.cat, 10);
                    if (!confirm('Xác nhận xóa yêu cầu này?')) return;
                    await performDelete(cat, id);
                    return;
                }
            });

            // delete from modal (Giữ nguyên)
            document.addEventListener('click', async function (e) {
                if (!e.target) return;
                if (e.target.id === 'deleteRequestBtn' || (e.target.closest && e.target.closest('#deleteRequestBtn'))) {
                    e.stopPropagation();
                    const modal = detailModalEl;
                    const catRaw = modal?.dataset?.selectedCat;
                    const idRaw = modal?.dataset?.selectedId;

                    const cat = (catRaw === undefined || catRaw === null) ? null : Number(catRaw);
                    const id = (idRaw === undefined || idRaw === null) ? null : Number(idRaw);

                    if (cat == null || id == null) {
                        showAlert('danger', 'Không xác định được yêu cầu để xóa.');
                        return;
                    }
                    if (!confirm('Xác nhận xóa yêu cầu này?')) return;
                    e.target.disabled = true;
                    try {
                        await performDelete(cat, id);
                        if (detailModal) detailModal.hide();
                    } finally {
                        e.target.disabled = false;
                    }
                }
            });

            // load detail (Giữ nguyên)
            async function loadDetail(cat, id) {
                if (detailModalEl) {
                    detailModalEl.dataset.selectedCat = String(cat);
                    detailModalEl.dataset.selectedId = String(id);
                }

                const body = document.getElementById('requestDetailBody');
                body.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';

                try {
                    const res = await fetch(`${URL_GET_DETAIL}?category=${encodeURIComponent(cat)}&id=${encodeURIComponent(id)}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
                    if (res.status === 404) {
                        body.innerHTML = '<div class="text-danger">Yêu cầu không tồn tại hoặc bạn không có quyền xem.</div>';
                        return;
                    }
                    if (!res.ok) {
                        const txt = await res.text();
                        body.innerHTML = `<div class="text-danger">Không tải được chi tiết: ${escapeHtml(txt)}</div>`;
                        return;
                    }
                    const d = await res.json();

                    if (detailModalEl) {
                        detailModalEl.dataset.selectedCat = String(d.category ?? cat);
                        detailModalEl.dataset.selectedId = String(d.id ?? id);
                    }

                    let html = `<div class="mb-2"><strong>Yêu cầu bởi:</strong> ${escapeHtml(d.requestedBy || '')} <br/><strong>Ngày:</strong> ${d.requestedAt ? new Date(d.requestedAt).toLocaleString() : ''}</div>`;
                    html += `<table class="table table-sm">`;

                        if (Number(d.category) === ENUM_BRANCH) {
                            html += `<tr><th>Tên chi nhánh</th><td>${escapeHtml(d.branchName || '')}</td></tr>`;
                            html += `<tr><th>Số điện thoại</th><td>${escapeHtml(d.branchPhone || '')}</td></tr>`;
                            html += `<tr><th>BranchId</th><td>${d.branchId ?? ''}</td></tr>`;
                        } else if (Number(d.category) === ENUM_EMPBR) {
                            html += `<tr><th>EmployeeId</th><td>${escapeHtml(d.employeeId || '')}</td></tr>`;
                            html += `<tr><th>Họ tên</th><td>${escapeHtml(d.fullName || '')}</td></tr>`;
                            html += `<tr><th>SĐT</th><td>${escapeHtml(d.phoneNumber || '')}</td></tr>`;
                            html += `<tr><th>BranchId</th><td>${d.branchId ?? ''}</td></tr>`;
                            html += `<tr><th>RegionId</th><td>${d.regionId ?? ''}</td></tr>`;
                            if (d.branchName) html += `<tr><th>Tên chi nhánh hiện tại (nếu có)</th><td>${escapeHtml(d.branchName)}</td></tr>`;
                        } else if (Number(d.category) === ENUM_PRODUCT) {
                            // image (if exists)
                            if (d.productImageUrl) {
                                html += `<tr><th>Ảnh</th><td><img src="${escapeHtml(d.productImageUrl)}" style="max-width:160px;max-height:120px;object-fit:contain;" alt="product image" /></td></tr>`;
                            }
                            html += `<tr><th>Tên sản phẩm</th><td>${escapeHtml(d.productName || '')}</td></tr>`;
                            html += `<tr><th>Mô tả</th><td style="white-space:pre-wrap;">${escapeHtml(d.productDescription || '')}</td></tr>`;
                            html += `<tr><th>Danh mục</th><td>${escapeHtml(d.productCategoryName || (d.productCategoryId ?? ''))}</td></tr>`;

                            // sizes — d.productSizes expected as array of { size, price }
                            if (Array.isArray(d.productSizes) && d.productSizes.length) {
                                html += `<tr><th>Các size</th><td><table class="table table-sm mb-0"><thead><tr><th>Size</th><th>Giá</th></tr></thead><tbody>`;
                                d.productSizes.forEach(s => {
                                    const sizeLabel = s.size || '';
                                    const priceLabel = (s.price == null) ? '' : Number(s.price).toLocaleString();
                                    html += `<tr><td>${escapeHtml(sizeLabel)}</td><td>${escapeHtml(priceLabel ? priceLabel + ' đ' : '')}</td></tr>`;
                                });
                                html += `</tbody></table></td></tr>`;
                            }
                        } else if (Number(d.category) === ENUM_CATEGORY) {
                            html += `<tr><th>CategoryId</th><td>${d.categoryId ?? ''}</td></tr>`;
                            html += `<tr><th>Tên danh mục</th><td>${escapeHtml(d.categoryName || '')}</td></tr>`;
                        }

                        html += `<tr><th>Trạng thái</th><td>${escapeHtml(d.status == 0 ? 'Chờ duyệt' : d.status == 1 ? 'Đã duyệt' : 'Bị từ chối')}</td></tr>`;
                        if (d.reviewedBy) html += `<tr><th>ReviewedBy</th><td>${escapeHtml(d.reviewedBy)}</td></tr>`;
                        if (d.rejectionReason) html += `<tr><th>Lý do từ chối</th><td>${escapeHtml(d.rejectionReason)}</td></tr>`;
                        html += `</table>`;
                        body.innerHTML = html;

                        // control delete button visibility from server flag (d.canDelete) if returned
                        if (deleteRequestBtn) {
                            if (d.canDelete === false) deleteRequestBtn.style.display = 'none';
                            else deleteRequestBtn.style.display = '';
                        }
                    } catch (err) {
                        console.error(err);
                        body.innerHTML = '<div class="text-danger">Lỗi khi tải chi tiết.</div>';
                    }
                }

            // perform delete (POST) (Giữ nguyên)
            async function performDelete(cat, id) {
                try {
                    const tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
                    const token = tokenEl ? tokenEl.value : '';
                    const form = new FormData();
                    form.append('category', String(cat));
                    form.append('id', String(id));
                    if (token) form.append('__RequestVerificationToken', token);

                    const res = await fetch(URL_DELETE, {
                        method: 'POST',
                        body: form,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'RequestVerificationToken': token || ''
                        },
                        credentials: 'same-origin'
                    });

                    let json = null;
                    const ctype = res.headers.get('content-type') || '';
                    if (ctype.indexOf('application/json') !== -1) {
                        json = await res.json();
                    } else {
                        const txt = await res.text();
                        try { json = JSON.parse(txt); } catch { json = { success: res.ok, message: txt }; }
                    }

                    if (!res.ok) {
                        const msg = json && json.message ? json.message : ('Lỗi server: ' + res.status);
                        showAlert('danger', msg);
                        return;
                    }

                    if (json && json.success) {
                        showAlert('success', json.message || 'Đã xóa yêu cầu.');
                        await loadList(currentCategory);
                    } else {
                        showAlert('danger', json && json.message ? json.message : 'Không xóa được yêu cầu.');
                    }
                } catch (err) {
                    console.error(err);
                    showAlert('danger', 'Lỗi server khi xóa.');
                }
            }

            // initial load (Giữ nguyên)
            loadList(currentCategory);
        });
    </script>
}