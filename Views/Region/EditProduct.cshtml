@model Product

@{
    ViewData["Title"] = "Edit Product";
}

<div style="margin-top: 80px;">
    <div class="container mt-5">
        <h2 class="mb-4 text-center">Edit Product</h2>

        <form asp-action="EditProduct" method="post" id="edit-product-form" class="shadow p-4 rounded bg-light">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="ProductID" />

            <div class="form-group mb-3">
                <label asp-for="ProductName" class="form-label"></label>
                <input asp-for="ProductName" class="form-control" />
                <span asp-validation-for="ProductName" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Description" class="form-label"></label>
                <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <!-- Image field: show current preview, allow choose new and upload -->
            <div class="form-group mb-3">
                <label class="form-label">Ảnh sản phẩm</label>
                <div id="currentImagePreview" style="margin-bottom:8px;">
                    @if (!string.IsNullOrEmpty(Model.Image_Url))
                    {
                        <img src="@Model.Image_Url"
                            style="max-width:180px;max-height:180px;border:1px solid #ddd;padding:4px;border-radius:6px;" />
                    }
                </div>
                <input id="editProductImageFile" type="file" accept="image/*" class="form-control" />
                <div id="editUploadStatus" style="margin-top:6px;font-size:13px;color:#666;"></div>
                <input asp-for="Image_Url" type="hidden" id="Edit_Image_Url" />
                <span id="editImageError" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="CategoryID" class="form-label">Category</label>
                <select asp-for="CategoryID" class="form-select" asp-items="ViewBag.Categories"></select>
                <span asp-validation-for="CategoryID" class="text-danger"></span>
            </div>

            <div class="form-check form-switch mb-4">
                <input asp-for="IsActive" class="form-check-input" type="checkbox" role="switch" />
                <label asp-for="IsActive" class="form-check-label"></label>
            </div>

            <hr />

            <h5 class="mb-3">Sizes & Prices</h5>
            <div id="sizes-container">
                @for (int i = 0; i < Model.ProductSizes.Count; i++)
                {
                    var ps = Model.ProductSizes.ToList()[i];
                    <div class="row g-2 mb-2 align-items-center size-entry">
                        <div class="col-5">
                            <label class="form-label visually-hidden">Size</label>
                            <select name="ProductSizes[@i].Size" class="form-select size-select" required>
                                <option value="">-- Size --</option>
                                @foreach (var s in new string[] { "S", "M", "L" })
                                {
                                    <option value="@s" selected="@(ps.Size == s)">@s</option>
                                }
                            </select>
                        </div>
                        <div class="col-5">
                            <label class="form-label visually-hidden">Price</label>
                            <input type="text" name="ProductSizes[@i].Price" value="@ps.Price.ToString("N0")"
                                class="form-control price-input" placeholder="Price (VND)" required />
                        </div>
                        <div class="col-2 text-end">
                            <input type="hidden" name="ProductSizes[@i].ProductSizeID" value="@ps.ProductSizeID" />
                            <button type="button" class="btn btn-danger btn-sm"
                                onclick="this.closest('.size-entry').remove(); updateEditDropdowns();">×</button>
                        </div>
                    </div>
                }
            </div>

            <button type="button" class="btn btn-outline-primary mb-3 mt-2" onclick="addEditSize()">
                <i class="fa fa-plus"></i> Add Size
            </button>
            <div class="text-danger mb-3" id="edit-size-error"></div>

            <div class="d-flex justify-content-between mt-4">
                <a asp-action="ViewProduct" class="btn btn-secondary px-4">Back</a>
                <button type="submit" class="btn btn-primary px-4">Update Product</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // sizes logic for edit form
        let editIndex = @Model.ProductSizes.Count;
        const allSizes = ["S", "M", "L"];

        function addEditSize() {
            const container = document.getElementById("sizes-container");
            const errorSpan = document.getElementById("edit-size-error");
            errorSpan.textContent = "";

            const existingSizes = Array.from(container.querySelectorAll("select.size-select"))
                .map(s => s.value);

            const availableSizes = allSizes.filter(s => !existingSizes.includes(s));

            if (availableSizes.length === 0) {
                errorSpan.textContent = "Bạn đã thêm tất cả các size (S, M, L)!";
                return;
            }

            const div = document.createElement("div");
            div.className = "row mb-2 align-items-center";

            const options = availableSizes.map(s => `<option value="${s}">${s}</option>`).join("");

            div.innerHTML = `
                    <div class="col-md-5">
                        <select name="ProductSizes[${editIndex}].Size" class="form-control size-select" required>
                            <option value="">-- Select Size --</option>
                            ${options}
                        </select>
                    </div>
                    <div class="col-md-5">
                        <input type="number" name="ProductSizes[${editIndex}].Price" class="form-control price-input" step="0.01" required />
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.remove(); updateEditDropdowns();">×</button>
                    </div>
                `;
            container.appendChild(div);
            editIndex++;
            updateEditDropdowns();
        }

        function updateEditDropdowns() {
            const container = document.getElementById("sizes-container");
            const selects = Array.from(container.querySelectorAll("select.size-select"));
            const selectedValues = selects.map(s => s.value);

            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `<option value="">-- Select Size --</option>` +
                    allSizes.filter(s => s === currentValue || !selectedValues.includes(s))
                        .map(s => `<option value="${s}" ${s === currentValue ? "selected" : ""}>${s}</option>`).join("");
            });
        }

        // Kiểm tra trùng size khi submit
        document.getElementById("edit-product-form").addEventListener("submit", function (e) {
            const errorSpan = document.getElementById("edit-size-error");
            errorSpan.textContent = "";

            const selects = Array.from(document.querySelectorAll("select.size-select"));
            const selectedSizes = selects.map(s => s.value).filter(v => v !== "");

            const duplicates = selectedSizes.filter((item, idx) => selectedSizes.indexOf(item) !== idx);
            if (duplicates.length > 0) {
                e.preventDefault();
                errorSpan.textContent = "Không được chọn trùng size: " + [...new Set(duplicates)].join(", ");
                return false;
            }

            // Chuyển dấu phẩy sang dấu chấm cho price
            const priceInputs = document.querySelectorAll('.price-input');
            priceInputs.forEach(inp => inp.value = inp.value.replace(',', '.'));
        });

        // --- Image upload for edit form(unsigned) ---
      (function() {
    const fileInput = document.getElementById('editProductImageFile');
    const previewContainer = document.getElementById('currentImagePreview');
    const status = document.getElementById('editUploadStatus');
    const hiddenUrl = document.getElementById('Edit_Image_Url');
    const imageError = document.getElementById('editImageError');

    const CLOUD_NAME = '@(ViewBag.Cloudinary_CloudName ?? "")';
    const UPLOAD_PRESET = '@(ViewBag.Cloudinary_UploadPreset ?? "")';
    const MAX_MB = 5;

    fileInput.addEventListener('change', async function() {
        imageError.textContent = '';
        status.textContent = '';
        // keep previous preview visible until upload success
        const file = this.files && this.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
            imageError.textContent = "Vui lòng chọn file ảnh.";
            return;
        }
        if (file.size > MAX_MB * 1024 * 1024) {
            imageError.textContent = `Kích thước file quá lớn (max ${MAX_MB} MB).`;
            return;
        }

        // local preview
        const reader = new FileReader();
        reader.onload = function (ev) {
            previewContainer.innerHTML = `<img src="${ev.target.result}" style="max-width:180px;max-height:180px;border:1px solid #ddd;padding:4px;border-radius:6px;" />`;
        };
        reader.readAsDataURL(file);

        status.textContent = 'Đang upload ảnh...';
        const fd = new FormData();
        fd.append('file', file);
        fd.append('upload_preset', UPLOAD_PRESET);

        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: fd
            });
            const json = await res.json();
            if (!res.ok) {
                const message = (json && json.error && json.error.message) ? json.error.message : 'Upload thất bại.';
                imageError.textContent = message;
                status.textContent = '';
                hiddenUrl.value = '';
                return;
            }
            const secureUrl = json.secure_url || json.url;
            if (!secureUrl) {
                imageError.textContent = "Không có URL trả về từ Cloudinary.";
                status.textContent = '';
                hiddenUrl.value = '';
                return;
            }
            status.textContent = 'Upload thành công.';
            hiddenUrl.value = secureUrl;
            previewContainer.innerHTML += `<div style="margin-top:6px;font-size:13px;color:#0a58ca">Link: <a href="${secureUrl}" target="_blank">mở ảnh</a></div>`;
        } catch (err) {
            console.error(err);
            imageError.textContent = 'Lỗi khi upload ảnh.';
            status.textContent = '';
            hiddenUrl.value = '';
        }
    });
})();
    </script>
}