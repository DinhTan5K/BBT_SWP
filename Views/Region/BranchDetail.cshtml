@using start.DTOs
@model start.DTOs.BranchDetail

@{
    ViewData["Title"] = "Chi nh√°nh: " + (Model?.Name ?? "");
    Layout = "~/Views/Shared/_RegionLayout.cshtml";
}

<link rel="stylesheet" href="~/css/Region/branch-info-details.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="region-dashboard-container">
    <div class="detail-header text-center">
        <h2 class="page-title">Chi nh√°nh: @Model.Name</h2>
    </div>

    <div class="top-row">
        <div class="card card-left">
            <h4 class="card-title">@Model.Name</h4>
            <p><strong>ƒê·ªãa ch·ªâ:</strong> @Model.Address</p>
            @if (!string.IsNullOrEmpty(Model.City))
            {
                <p><strong>Th√†nh ph·ªë:</strong> @Model.City</p>
            }
            @if (!string.IsNullOrEmpty(Model.Phone))
            {
                <p><strong>S·ªë ƒëi·ªán tho·∫°i chi nh√°nh:</strong> @Model.Phone</p>
            }

            <p><strong>Qu·∫£n l√Ω chi nh√°nh:</strong> @(string.IsNullOrEmpty(Model.ManagerName) ? "Ch∆∞a ƒë∆∞·ª£c ph√¢n c√¥ng" :
                                Model.ManagerName)</p>
            @if (!string.IsNullOrEmpty(Model.ManagerPhone))
            {
                <p><strong>SƒêT qu·∫£n l√Ω:</strong> @Model.ManagerPhone</p>
            }

            <div style="margin-top:18px; display:flex; gap:12px;">
                <a asp-action="RegionHome" asp-controller="Region" class="detail-btn">‚Üê Quay v·ªÅ</a>

            </div>
        </div>

        <div class="card card-right">
            <h5 class="card-title">V·ªã tr√≠ chi nh√°nh</h5>

            @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
            {
                <div id="branch-map" class="branch-map"></div>
                <div style="margin-top:10px">
                    <a id="openGoogleMapsBtn" target="_blank" class="map-btn">üìç M·ªü tr√™n Google Maps</a>
                </div>
            }
            else
            {
                <p class="text-muted">Kh√¥ng c√≥ to·∫° ƒë·ªô.</p>
            }
        </div>
    </div>

    <div class="employees-row">
        <div class="card employees-card">
            <h5 class="card-title">Danh s√°ch nh√¢n vi√™n</h5>

            @if (Model.Employees == null || !Model.Employees.Any())
            {
                <p class="text-muted">Ch∆∞a c√≥ nh√¢n vi√™n.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>T√™n</th>
                                <th>V·ªã tr√≠</th>
                                <th>Ng√†y sinh</th>
                                <th>SƒêT</th>
                                <th>Email</th>
                                <th>Ng√†y v√†o l√†m</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var e in Model.Employees)
                            {
                                <tr>
                                    <td>@e.FullName</td>
                                    <td>
                                        @{
                                            string position = e.RoleId switch
                                            {
                                                "EM" => "Nh√¢n vi√™n",
                                                "SL" => "Tr∆∞·ªüng ca",
                                                _ => "Kh√°c"
                                            };
                                        }
                                        @position
                                    </td>
                                    <td>@(e.DateOfBirth?.ToString("yyyy-MM-dd") ?? "-")</td>
                                    <td>@(e.PhoneNumber ?? "-")</td>
                                    <td>@(e.Email ?? "-")</td>
                                    <td>@e.HireDate.ToString("yyyy-MM-dd")</td>

                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // gi·ªØ nguy√™n script b·∫£n ƒë·ªì nh∆∞ b·∫°n c√≥
    window.addEventListener('load', function () {
        var mapDiv = document.getElementById('branch-map');
        if (!mapDiv) return;

        const latRaw = @System.Text.Json.JsonSerializer.Serialize(Model.Latitude);
        const lngRaw = @System.Text.Json.JsonSerializer.Serialize(Model.Longitude);

        if (latRaw !== null && lngRaw !== null) {
            const lat = Number(latRaw);
            const lng = Number(lngRaw);
            if (!isNaN(lat) && !isNaN(lng)) {
                var map = L.map('branch-map').setView([lat, lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                var marker = L.marker([lat, lng]).addTo(map);
                marker.bindPopup(`<b>@Html.Raw(System.Net.WebUtility.HtmlEncode(Model.Name))</b><br/>@Html.Raw(System.Net.WebUtility.HtmlEncode(Model.Address ?? ""))`).openPopup();

                setTimeout(function () { map.invalidateSize(); }, 200);

                var mapsBtn = document.getElementById('openGoogleMapsBtn');
                if (mapsBtn) { mapsBtn.href = `https://www.google.com/maps?q=${lat},${lng}`; }
            }
        }
    });
</script>