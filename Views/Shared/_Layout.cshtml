@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@inject start.Data.ApplicationDbContext _context
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
<!DOCTYPE html>
<html lang="en">

@{
    // Lấy CustomerID từ Claims (CustomerScheme) thay vì Session
    int? customerId = null;
    string? customerName = null;
    string? customerAvatar = null;

    // Try to get CustomerID from CustomerScheme authentication
    var authResult = HttpContextAccessor.HttpContext?.AuthenticateAsync("CustomerScheme").Result;
    if (authResult?.Succeeded == true)
    {
        var userIdClaim = authResult.Principal?.FindFirstValue(ClaimTypes.NameIdentifier);
        if (int.TryParse(userIdClaim, out int customerIdValue))
        {
            customerId = customerIdValue;
            var ctm = _context.Customers.Find(customerId.Value);
            customerName = ctm?.Name;
            customerAvatar = ctm?.ProfileImagePath;
        }
    }

    var avatarUrl = string.IsNullOrEmpty(customerAvatar)
    ? Url.Content("https://res.cloudinary.com/do48qpmut/image/upload/v1761645429/uploads/tdppvgyas8bhvfs7lton.png")
    : Url.Content(customerAvatar);

    var currentController = ViewContext.RouteData.Values["Controller"]?.ToString()?.ToLowerInvariant();
    var currentAction = ViewContext.RouteData.Values["Action"]?.ToString()?.ToLowerInvariant();
    var hideAuth = currentController == "home" && (currentAction == "login" || currentAction == "register");
}

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/Layout/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/start.styles.css" asp-append-version="true" />
    <link rel="shortcut icon" type="image/x-icon" href="https://res.cloudinary.com/do48qpmut/image/upload/v1761655863/rtqvgmhsxpjtavejobfy.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Muli:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&display=swap" rel="stylesheet">
    @await RenderSectionAsync("Styles", required: false)
</head>

<body
    style="display:flex; flex-direction:column; min-height:100vh; margin:0; font-family:'Muli', sans-serif; position: relative;">

    <header style="position: relative; z-index: 10;">
        <div class="taskbar">

            <div class="logo-title">
                <a asp-controller="Home" asp-action="Index" class="logo-link">
                    <img src="https://res.cloudinary.com/do48qpmut/image/upload/v1761645429/uploads/tdppvgyas8bhvfs7lton.png" alt="Logo" />
                    <span class="brand-title">
                        Buble <span class="brand-hub">Tea</span>
                    </span>
                </a>
            </div>


            <nav class="function">
                <ul>
                    <li><a asp-controller="Home" asp-action="Introduce">GIỚI THIỆU</a></li>
                    <li><a asp-controller="Product" asp-action="Product">THỰC ĐƠN</a></li>
                    <li><a asp-controller="Home" asp-action="News">TIN TỨC</a></li>
                    <li><a asp-controller="Contact" asp-action="Contact">LIÊN HỆ</a></li>
                    <li><a asp-controller="Home" asp-action="Store">CỬA HÀNG</a></li>
                </ul>
            </nav>

            @if (!hideAuth)
            {
                <div class="auth">
                    @if (customerId != null || (User?.Identity?.IsAuthenticated ?? false))
                    {
                        <div class="auth-logged">

                            <a asp-controller="Home" asp-action="Privacy" class="nav-privacy" title="Privacy">
                                <span class="bell-wrap" aria-hidden="true">
                                    <i class="fa-regular fa-bell bell-icon" aria-hidden="true"></i>
                                </span>
                                <span class="nav-privacy-text">Privacy</span>
                            </a>

                            @* separator dọc nhỏ *@
                            <span class="nav-sep" aria-hidden="true"></span>

                            @* avatar dropdown (giữ nguyên) *@
                            <div class="dropdown">
                                <div class="d-flex justify-content-center align-items-center" style="height:80px;">
                                    <a class="avatar-btn" href="#" role="button" data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                        <img src="@avatarUrl" alt="Avatar" />
                                    </a>

                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <span class="dropdown-item-text customer-name" title="@customerName">
                                                Xin chào, <b>@customerName</b>
                                            </span>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" asp-controller="Account" asp-action="Profile">Thông tin cá
                                                nhân</a>
                                        </li>
                                        <li>
                                            <a asp-controller="Account" asp-action="Logout"
                                                class="dropdown-item text-danger">Đăng Xuất</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <a asp-controller="Account" asp-action="Login" class="btn-auth login">Đăng Nhập</a>
                        <a asp-controller="Account" asp-action="Register" class="btn-auth register">Đăng Ký</a>
                    }
                </div>
            }
        </div>
    </header>

    <main>
        @RenderBody()
    </main>


    <footer class="fnb-footer" style="position: relative; z-index: 10;">
        <div class="footer-container">
            <div class="footer-left">
                <p class="footer-text">&copy; 2025 - Milk & Tea Shop | <a asp-controller="Home"
                        asp-action="Privacy">Privacy</a></p>
            </div>
            <div class="footer-right">
                <a href="#" class="social-icon"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="social-icon"><i class="fab fa-instagram"></i></a>
                <a href="#" class="social-icon"><i class="fa-solid fa-comment-dots"></i></a>
            </div>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)

    <div id="chatbot-container">
        <div id="chatbot-header">
            <span>Buble Tea Chat</span>
            <button id="close-chat">✕</button>
        </div>
        <div id="chatbot-body">
            <div id="chatbot-messages"></div>
        </div>
        <div id="chatbot-input">
            <input type="text" id="chatbot-question" placeholder="Nhập câu hỏi..." />
            <button id="send-chat"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <button id="chatbot-toggle">
        <img id="chatbot-avatar" src="@Url.Content("https://res.cloudinary.com/do48qpmut/image/upload/v1761645461/uploads/gfygjmyo6m7vf6kfcepg.jpg")" alt="AI Avatar" />
    </button>

    <script>
        const chatbotContainer = document.getElementById("chatbot-container");
        const chatbotToggle = document.getElementById("chatbot-toggle");
        const closeChat = document.getElementById("close-chat");
        const sendChat = document.getElementById("send-chat");
        const questionInput = document.getElementById("chatbot-question");
        const messagesDiv = document.getElementById("chatbot-messages");

        // ✨ Cập nhật URL Avatar và lời chào
        const aiAvatarUrl = '@Url.Content("https://res.cloudinary.com/do48qpmut/image/upload/v1761645461/uploads/gfygjmyo6m7vf6kfcepg.jpg")';
        const userAvatarUrl = '@avatarUrl';
        const defaultWelcomeMessage = "Xin chào bro! Mình là AI tư vấn của Buble Tea. Bro cần mình hỗ trợ thông tin gì về menu, sản phẩm, hoặc chương trình khuyến mãi không? Cứ hỏi nhé! 😉";

        // ✨ HÀM HIỂN THỊ TIN NHẮN TỪ BOT (có hỗ trợ avatar và loading)
        function displayBotMessage(message, is_loading = false, autoScroll = true) {
            if (!message || message === 'undefined' || message === 'null') {
                console.warn("Không thể hiển thị message: message is invalid");
                return;
            }
            const loadingId = is_loading ? " id='loading-ai-msg'" : "";
            const safeMessage = String(message || '').trim();
            if (!safeMessage) return;
            messagesDiv.innerHTML += `<div class='ai-msg'><img class='ai-avatar' src='${aiAvatarUrl}' alt='AI Avatar'/><div class='ai-msg-content'${loadingId}>${safeMessage}</div></div>`;
            if (autoScroll) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // ✨ HÀM HIỂN THỊ TIN NHẮN TỪ USER (có hỗ trợ avatar)
        function displayUserMessage(question, autoScroll = true) {
            if (!question || question === 'undefined' || question === 'null') {
                console.warn("Không thể hiển thị question: question is invalid");
                return;
            }
            const safeQuestion = String(question || '').trim();
            if (!safeQuestion) return;

            // ✨✨✨ ĐÂY LÀ PHẦN QUAN TRỌNG NHẤT ✨✨✨
            // Đảo ngược thứ tự: Avatar lên trước, Content ra sau.
            // CSS flex-direction: row-reverse sẽ đảo lại thành Content (trái) -> Avatar (phải).
            messagesDiv.innerHTML += `
        <div class='user-msg'>
            <img class='user-avatar' src='${userAvatarUrl}' alt='User Avatar'/>
            <div class='ai-msg-content'>${safeQuestion}</div>
        </div>
    `;
            // ------------------------------------------

            if (autoScroll) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // ✨ HÀM HIỂN THỊ LỜI CHÀO MỪNG TỰ ĐỘNG
        function displayWelcomeMessage() {
            // Chỉ hiển thị nếu chưa có tin nhắn nào
            if (messagesDiv.children.length === 0) {
                displayBotMessage(defaultWelcomeMessage);
                // Đảm bảo scroll xuống cuối sau khi hiển thị welcome message
                setTimeout(() => {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }, 50);
            }
        }

        // ✨ HÀM LOAD LỊCH SỬ CHAT TỪ DATABASE
        async function loadChatHistory() {
            try {
                const res = await fetch("/Ai/GetChatHistory", {
                    method: "GET",
                    headers: { "Content-Type": "application/json" }
                });

                const data = await res.json();
                
                console.log("📥 Chat history loaded:", data.history?.length || 0, "messages");
                
                if (data.history && data.history.length > 0) {
                    // Xóa welcome message nếu có
                    messagesDiv.innerHTML = "";
                    
                    // Hiển thị lại tất cả tin nhắn từ lịch sử (TẮT autoScroll để không scroll từng tin nhắn)
                    data.history.forEach((item, index) => {
                        // Dùng camelCase (question, answer) thay vì PascalCase
                        const question = item.question || item.Question;
                        const answer = item.answer || item.Answer;
                        
                        console.log(`Message ${index}:`, { question: question, answer: answer?.substring(0, 50) });
                        
                        // Hiển thị Question nếu có (TẮT autoScroll)
                        if (question && String(question).trim() !== '' && String(question) !== 'undefined' && String(question) !== 'null') {
                            displayUserMessage(question, false); // false = không auto scroll
                        }
                        
                        // Hiển thị Answer nếu có (TẮT autoScroll)
                        if (answer && String(answer).trim() !== '' && String(answer) !== 'undefined' && String(answer) !== 'null') {
                            displayBotMessage(answer, false, false); // false, false = không loading, không auto scroll
                        }
                    });
                    
                    // CHỈ scroll một lần cuối cùng sau khi load xong TẤT CẢ tin nhắn
                    // Dùng nhiều cách để đảm bảo scroll được
                    const scrollToBottom = () => {
                        // Cách 1: Scroll đến phần tử cuối cùng
                        const lastChild = messagesDiv.lastElementChild;
                        if (lastChild) {
                            lastChild.scrollIntoView({ behavior: 'instant', block: 'end' });
                        }
                        // Cách 2: Dùng scrollTop (backup)
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    };
                    
                    // Chờ DOM render xong rồi scroll
                    setTimeout(() => {
                        scrollToBottom();
                        // Thử lại sau 100ms
                        setTimeout(scrollToBottom, 100);
                        // Thử lại sau 300ms để chắc chắn DOM đã render xong
                        setTimeout(scrollToBottom, 300);
                    }, 50);
                } else {
                    console.log("📭 No chat history found, showing welcome message");
                    // Nếu không có lịch sử, hiển thị welcome message
                    displayWelcomeMessage();
                }
            } catch (error) {
                console.error("Lỗi load chat history:", error);
                // Nếu lỗi, vẫn hiển thị welcome message
                displayWelcomeMessage();
            }
        }

        chatbotToggle.addEventListener("click", () => {
            chatbotContainer.style.display = "flex";
            chatbotToggle.style.display = "none";
            // Load lịch sử chat thay vì chỉ hiển thị welcome message
            // loadChatHistory() sẽ tự scroll xuống cuối sau khi load xong
            loadChatHistory();
        });

        closeChat.addEventListener("click", () => {
            chatbotContainer.style.display = "none";
            chatbotToggle.style.display = "flex";
        });

        async function sendMessage() {
            const question = questionInput.value.trim();
            if (!question) return;

            // hiển thị câu hỏi người dùng (Dùng hàm mới)
            displayUserMessage(question);
            questionInput.value = "";

            // hiển thị loading (Dùng hàm mới)
            displayBotMessage(`<i class='fas fa-spinner fa-spin'></i> Đang suy nghĩ...`, true);

            try {
                // gọi API
                const res = await fetch("/Ai/Ask", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: "question=" + encodeURIComponent(question)
                });

                const data = await res.json();

                // 4. XÓA loading message (BẰNG CÁCH GỌI ID)
                const loadingMsgContent = document.getElementById('loading-ai-msg');
                if (loadingMsgContent) {
                    // Xóa phần tử cha (.ai-msg) chứa cả avatar và loading text
                    loadingMsgContent.parentElement.remove();
                }

                // hiển thị câu trả lời (Dùng hàm mới)
                displayBotMessage(data.answer);
                 if (data.redirectUrl) {
                    // Tăng delay lên 2.5 giây để đảm bảo server kịp lưu lịch sử vào database
                    setTimeout(function() {
                        window.location.href = data.redirectUrl;
                    }, 2500);
                }

            } catch (error) {
                // Xử lý lỗi
                const loadingMsgContent = document.getElementById('loading-ai-msg');
                if (loadingMsgContent) {
                    loadingMsgContent.parentElement.remove();
                }

                displayBotMessage("Có lỗi xảy ra khi kết nối AI. Vui lòng thử lại sau.");
            }
        }

        sendChat.addEventListener("click", sendMessage);
        questionInput.addEventListener("keypress", e => {
            if (e.key === "Enter") sendMessage();
        });
    </script>

    <style>
        /* ✨ BẢNG MÀU THƯƠNG HIỆU (ROOT VARIABLES) */
        :root {
            --mt-bg: #fffaf2;
            --mt-surface: #ffffff;
            --mt-text: #2d261f;
            --mt-muted: #6b5b4d;
            --mt-brand: #ffb74d;
            /* Màu cam/vàng nhạt */
            --mt-brand-dark: #d98c2b;
            --mt-accent: #6f4e37;
            /* Màu nâu đậm (dùng cho header, nút) */
            --mt-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);

            --tea-cream: #f6efe6;
            /* Màu kem nhạt cho tin nhắn AI */
            --tea-light: #e9d6c1;
            --tea-medium: #c9a77a;
            --tea-dark: #8b5e3c;
            --shadow: rgba(0, 0, 0, 0.12);
        }

        /* Chat icon (Nút Toggle) */
        #chatbot-toggle {
            position: fixed;
            bottom: 20px;
            right: 25px;
            /* Màu nút theo Brand Accent */
            background-color: var(--mt-accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            overflow: hidden;
        }

        #chatbot-toggle:hover {
            background-color: var(--tea-dark);
        }

        /* Avatar trên nút toggle */
        #chatbot-toggle #chatbot-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Chat box */
        #chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 25px;
            width: 350px;
            height: 450px;
            background: var(--mt-surface);
            border: 1px solid var(--tea-light);
            border-radius: 10px;
            box-shadow: var(--mt-shadow);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
        }

        #chatbot-header {
            /* Màu Header theo Brand Accent */
            background-color: var(--mt-accent);
            color: var(--mt-surface);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chatbot-header button {
            background: none;
            border: none;
            color: var(--mt-surface);
            font-size: 18px;
            cursor: pointer;
        }

        #chatbot-body {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-size: 14px;
            /* Màu nền cho body chat */
            background-color: var(--mt-bg);
        }

        /* --- Input Container (Khối bao quanh Input và nút gửi) --- */
        #chatbot-input {
            display: flex;
            /* Đã dùng border-top: 1px solid var(--tea-light) ở phần trước, ta giữ nguyên */
            border-top: 1px solid var(--tea-light);
            background-color: var(--mt-surface);
            /* Nền trắng */
            padding: 5px;
            /* Thêm padding nhẹ cho toàn bộ khối input */
        }

        /* --- Trường Nhập liệu (Input Text) --- */
        #chatbot-input input {
            flex: 1;
            /* Xóa viền gốc */
            border: none;
            /* Viền mới: dùng màu trà sữa nhạt */
            border-radius: 20px;
            padding: 10px 15px;
            /* Tăng padding để trông dày dặn hơn */
            outline: none;
            background-color: var(--tea-cream);
            /* Màu nền nhẹ cho trường nhập liệu */
            color: var(--mt-text);
            /* Bỏ padding cũ, đã gộp vào padding mới */
        }

        /* --- Nút Gửi (Send Button) --- */
        #chatbot-input button {
            /* Đã sửa ở lần trước, giữ nguyên */
            background-color: var(--mt-accent);
            border: none;
            color: white;
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 50%;
            /* Làm nút tròn */
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
            /* Khoảng cách với input */
        }

        #chatbot-input button i {
            font-size: 16px;
        }

        /* Messages container */
        .user-msg,
        .ai-msg {
            margin: 8px 0;
            max-width: 90%;
            word-wrap: break-word;
            display: flex;
        }

        /* AI Message (Left side) */
        .ai-msg {
            align-items: flex-start;
            align-self: flex-start;
            margin-right: auto;
        }

        /* User Message (Right side) */
        .user-msg {
            align-items: flex-end;
            align-self: flex-end;
            margin-left: auto;
            flex-direction: row-reverse;
        }

        /* Avatar cho AI và User */
        .ai-avatar,
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        /* Khoảng cách cho Avatar AI */
        .ai-msg .ai-avatar {
            margin-right: 8px;
            margin-left: 0;
            align-self: flex-start;
        }

        /* Khoảng cách cho Avatar User */
        .user-msg .user-avatar {
            margin-left: 8px;
            margin-right: 0;
            align-self: flex-end;
        }


        /* Nội dung tin nhắn chính */
        .ai-msg-content {
            padding: 10px 12px;
            font-family: 'Muli', sans-serif;
            font-weight: 500;
            font-size: 15px;
            line-height: 1.5;
            white-space: pre-wrap;
            /* ✨ Đã sửa lại thành pre-wrap để xử lý Markdown/xuống dòng tốt hơn */
            min-width: 0;
            box-shadow: 0 1px 1px var(--shadow);
            max-width: 100%;
        }

        /* Style cho tin nhắn AI */
        .ai-msg .ai-msg-content {
            /* Màu tin nhắn AI theo màu kem trà */
            background-color: var(--tea-cream);
            color: var(--mt-text);
            border-radius: 0 12px 12px 12px;
        }

        /* Style cho tin nhắn người dùng */
        .user-msg .ai-msg-content {
            /* Màu tin nhắn người dùng theo màu Brand */
            background-color: var(--mt-brand);
            color: var(--mt-text);
            border-radius: 12px 0 12px 12px;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

</body>

</html>