@using Microsoft.AspNetCore.Http
@{
    // T√™n hi·ªÉn th·ªã
    var empName = Context.Session.GetString("EmployeeName") ?? User?.Identity?.Name ?? "T√†i kho·∫£n";
    var regionName = Context.Session.GetString("RegionName") ?? "Ch∆∞a x√°c ƒë·ªãnh";

    // Avatar: ∆∞u ti√™n l∆∞u trong session, fallback sang claim "AvatarUrl" n·∫øu c√≥, r·ªìi fallback sang ·∫£nh m·∫∑c ƒë·ªãnh
    var avatarUrl = Context.Session.GetString("AvatarUrl");
    if (string.IsNullOrEmpty(avatarUrl))
    {
        try
        {
            // n·∫øu b·∫°n l∆∞u avatar url trong claim (khi ƒëƒÉng nh·∫≠p), ƒë·ªçc t·ª´ User
            var claimAvatar = User?.FindFirst("AvatarUrl")?.Value;
            if (!string.IsNullOrEmpty(claimAvatar))
            {
                avatarUrl = claimAvatar;
            }
        }
        catch
        {
            // ignore
        }
    }

    // N·∫øu v·∫´n null => d√πng ·∫£nh m·∫∑c ƒë·ªãnh trong wwwroot/images/default-avatar.png
    if (string.IsNullOrEmpty(avatarUrl))
    {
        avatarUrl = Url.Content("~/images/default-avatar.png");
    }

    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - Region Management</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/Region/region-layout.css" />

    @* Render optional per-view styles section (fix for the exception you saw) *@
    @RenderSection("Styles", required: false)
</head>

<body>
    <div class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-top">
                <div class="brand">
                    <div class="brand-icon">üåç</div>
                    <div class="brand-text">
                        <div class="brand-title">Region Management Portal</div>
                        <div class="brand-sub">Qu·∫£n l√Ω khu v·ª±c</div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a asp-controller="Region" asp-action="RegionHome" class="nav-link">
                            <span class="nav-dot"></span> T·∫•t c·∫£ chi nh√°nh
                        </a>
                    </li>
                    <li>
                        <a asp-controller="Region" asp-action="ManageBranchStatus" class="nav-link">
                            <span class="nav-dot"></span> Qu·∫£n l√Ω t√¨nh tr·∫°ng chi nh√°nh
                        </a>
                    </li>
                    <li>
                        <a asp-controller="Region" asp-action="ViewProduct" class="nav-link">
                            <span class="nav-dot"></span> Qu·∫£n l√Ω s·∫£n ph·∫©m
                        </a>
                    </li>
                    <li>
                        <a asp-controller="Region" asp-action="Statistics" class="nav-link">
                            <span class="nav-dot"></span> Th·ªëng k√™ & B√°o c√°o doanh thu
                        </a>
                    </li>
                    <li><a asp-controller="Region" asp-action="SentRequests" class="nav-link">Y√™u c·∫ßu ƒë√£ g·ª≠i</a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
            </div>
        </aside>

        <div class="main-area">
            <header class="top-header">
                <div class="header-left">
                    <div class="region-info-box">
                        <div class="region-label">Khu v·ª±c: <span class="region-name-highlight">Mi·ªÅn @regionName</span>
                        </div>
                        <div class="manager-name"><span class="manager-name-highlight">Ng∆∞·ªùi qu·∫£n l√Ω: @empName</span>
                        </div>
                    </div>
                </div>

                <div class="header-right">
                    <div class="user-block dropdown">
                        <a class="user-toggle" href="#" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
                            @* Avatar d√πng avatarUrl; onerror fallback v·ªÅ ·∫£nh m·∫∑c ƒë·ªãnh *@
                            <img src="@avatarUrl" alt="avatar" class="user-avatar"
                                 onerror="this.onerror=null;this.src='@Url.Content("~/images/default-avatar.png")';" />
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                            <li><a class="dropdown-item" asp-controller="Employee" asp-action="Profile">H·ªì s∆°</a></li>
                            <li>
                                <hr class="dropdown-divider" />
                            </li>
                            <li><a class="dropdown-item text-danger" asp-controller="Account" asp-action="Logout">ƒêƒÉng
                                    Xu·∫•t</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <main class="page-body">
                <div class="container-fluid">
                    @RenderBody()
                </div>
            </main>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Th√™m hi·ªáu ·ª©ng active d·ª±a tr√™n route hi·ªán t·∫°i
        $(document).ready(function () {
            var currentUrl = window.location.pathname;

            $('.sidebar-nav a.nav-link').each(function () {
                // L·∫•y href ƒë·∫ßy ƒë·ªß (c√≥ th·ªÉ l√† ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi)
                var linkUrl = $(this).attr('href');
                if (linkUrl && currentUrl.indexOf(linkUrl) !== -1) {
                    $(this).addClass('active');
                }
            });
        });
    </script>

    <partial name="_ValidationScriptsPartial" />
    @RenderSection("Scripts", required: false)
</body>

</html>
