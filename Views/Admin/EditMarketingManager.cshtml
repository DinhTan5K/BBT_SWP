@model start.Models.Employee
@using start.Models
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Sửa thông tin Marketing Manager";
}

<div style="padding: 24px;">
    <div style="margin-bottom: 24px;">
        <a href="@Url.Action("Employees", "Admin", new { tab = "marketingManagers" })" 
           style="display: inline-flex; align-items: center; gap: 8px; color: var(--admin-primary); text-decoration: none; font-weight: 500; margin-bottom: 16px;">
            <i class="fas fa-arrow-left"></i> Quay lại danh sách
        </a>
        <h2 style="font-size: 24px; font-weight: 600; color: var(--ink); margin: 0;">
            Sửa thông tin Marketing Manager
        </h2>
    </div>

    <form id="editMMForm" style="background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 24px; max-width: 800px;">
        @Html.AntiForgeryToken()
        <input type="hidden" id="employeeId" name="employeeId" value="@Model.EmployeeID">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Mã MM</label>
                <input type="text" value="@Model.EmployeeID" disabled 
                       style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px; background: var(--bg);">
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Họ tên <span style="color: red;">*</span></label>
                <input type="text" id="fullName" name="fullName" value="@Model.FullName" required 
                       style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px;"
                       placeholder="Nhập họ tên">
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Email <span style="color: red;">*</span></label>
                <input type="email" id="email" name="email" value="@Model.Email" required 
                       style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px;"
                       placeholder="example@email.com">
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Số điện thoại <span style="color: red;">*</span></label>
                <input type="tel" id="phoneNumber" name="phoneNumber" value="@Model.PhoneNumber" required 
                       style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px;"
                       placeholder="0901234567">
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Ngày sinh</label>
                <input type="date" id="dateOfBirth" name="dateOfBirth" value="@(Model.DateOfBirth?.ToString("yyyy-MM-dd") ?? "")" 
                       style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Giới tính</label>
                <select id="gender" name="gender" 
                        style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px;">
                    <option value="">Chọn giới tính</option>
                    @if (Model.Gender == "Nam")
                    {
                        <option value="Nam" selected>Nam</option>
                    }
                    else
                    {
                        <option value="Nam">Nam</option>
                    }
                    @if (Model.Gender == "Nữ")
                    {
                        <option value="Nữ" selected>Nữ</option>
                    }
                    else
                    {
                        <option value="Nữ">Nữ</option>
                    }
                    @if (Model.Gender == "Khác")
                    {
                        <option value="Khác" selected>Khác</option>
                    }
                    else
                    {
                        <option value="Khác">Khác</option>
                    }
                </select>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Thành phố</label>
                <input type="text" id="city" name="city" value="@Model.City" 
                       style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px;"
                       placeholder="Hà Nội">
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Vai trò</label>
                <input type="text" value="Marketing Manager" disabled 
                       style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px; background: var(--bg);">
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Quốc tịch</label>
                <input type="text" id="nationality" name="nationality" value="@(Model.Nationality ?? "Việt Nam")"
                       style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px;"
                       placeholder="Việt Nam">
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Dân tộc</label>
                <input type="text" id="ethnicity" name="ethnicity" value="@(Model.Ethnicity ?? "Kinh")"
                       style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px;"
                       placeholder="Kinh">
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Số điện thoại khẩn cấp 1</label>
                <input type="tel" id="emergencyPhone1" name="emergencyPhone1" value="@Model.EmergencyPhone1" 
                       style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px;"
                       placeholder="0901234567">
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--ink);">Số điện thoại khẩn cấp 2</label>
                <input type="tel" id="emergencyPhone2" name="emergencyPhone2" value="@Model.EmergencyPhone2" 
                       style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px;"
                       placeholder="0901234567">
            </div>
        </div>

        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
            <a href="@Url.Action("Employees", "Admin", new { tab = "marketingManagers" })" 
               style="padding: 10px 20px; background: var(--bg); color: var(--ink); border: 1px solid var(--line); border-radius: 8px; font-weight: 500; text-decoration: none; display: inline-block;">
                Hủy
            </a>
            <button type="submit" 
                    style="padding: 10px 20px; background: var(--admin-primary); color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer;">
                <i class="fas fa-save"></i> Cập nhật
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        document.getElementById('editMMForm')?.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const data = {
                employeeId: formData.get('employeeId'),
                fullName: formData.get('fullName'),
                email: formData.get('email'),
                phoneNumber: formData.get('phoneNumber'),
                dateOfBirth: formData.get('dateOfBirth') || null,
                gender: formData.get('gender') || null,
                city: formData.get('city') || null,
                nationality: formData.get('nationality') || null,
                ethnicity: formData.get('ethnicity') || null,
                emergencyPhone1: formData.get('emergencyPhone1') || null,
                emergencyPhone2: formData.get('emergencyPhone2') || null,
                __RequestVerificationToken: token
            };

            const body = Object.keys(data).map(key => {
                if (data[key] === null) return '';
                return `${encodeURIComponent(key)}=${encodeURIComponent(data[key])}`;
            }).filter(x => x).join('&');

            fetch('@Url.Action("EditMarketingManager", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: body
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.href = '@Url.Action("Employees", "Admin", new { tab = "marketingManagers" })';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật thông tin Marketing Manager.');
            });
        });
    </script>
}

