@model start.Models.Employee
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Dashboard";
    // ViewBag.ActiveMenu đã được set trong Controller, không cần set lại ở đây

    var avatar = !string.IsNullOrWhiteSpace(Model.AvatarUrl)
         ? Url.Content(Model.AvatarUrl) 
        : Url.Content("https://res.cloudinary.com/do48qpmut/image/upload/v1761645429/uploads/tdppvgyas8bhvfs7lton.png");
}

<div style="padding: 24px;">
    <div class="profile-head">
        <div class="avatar"><img src="@avatar" alt="avatar"></div>
        <div>
            <h3 class="name">@Model.FullName</h3>
            <div class="position">Quản trị viên</div>
        </div>
    </div>

    <div style="margin-top: 32px;">
        <h2 style="font-size: 24px; font-weight: 600; margin-bottom: 20px; color: var(--ink);">
            Tổng quan hệ thống
        </h2>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Tổng nhân viên</div>
                <div style="font-size: 32px; font-weight: 700;">@ViewBag.TotalEmployees</div>
            </div>

            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Tổng đơn hàng</div>
                <div style="font-size: 32px; font-weight: 700;">@ViewBag.TotalOrders</div>
            </div>

            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Tổng khách hàng</div>
                <div style="font-size: 32px; font-weight: 700;">@ViewBag.TotalCustomers</div>
            </div>

            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Tổng sản phẩm</div>
                <div style="font-size: 32px; font-weight: 700;">@ViewBag.TotalProducts</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-top: 24px;">
            <!-- Biểu đồ tròn - Đơn hàng theo trạng thái -->
            <div style="background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 24px;">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--ink);">Đơn hàng theo trạng thái</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="orderStatusChart"></canvas>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #cbd5e1; border-radius: 3px;"></div>
                        <span style="font-size: 12px; color: var(--muted);">Chờ xác nhận: @ViewBag.PendingOrders</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #dbeafe; border-radius: 3px;"></div>
                        <span style="font-size: 12px; color: var(--muted);">Đã xác nhận: @ViewBag.ConfirmedOrders</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #ddd6fe; border-radius: 3px;"></div>
                        <span style="font-size: 12px; color: var(--muted);">Đang giao: @ViewBag.ShippingOrders</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #d1fae5; border-radius: 3px;"></div>
                        <span style="font-size: 12px; color: var(--muted);">Đã giao: @ViewBag.DeliveredOrders</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #fee2e2; border-radius: 3px;"></div>
                        <span style="font-size: 12px; color: var(--muted);">Đã hủy: @ViewBag.CancelledOrders</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #e0e7ff; border-radius: 3px; border: 1.5px solid #6366f1;"></div>
                        <span style="font-size: 12px; color: var(--muted);">Chờ hoàn tiền: @ViewBag.PendingRefundOrders</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 12px; height: 12px; background: #e0e7ff; border-radius: 3px;"></div>
                        <span style="font-size: 12px; color: var(--muted);">Đã hoàn tiền: @ViewBag.RefundedOrders</span>
                    </div>
                </div>
            </div>

            <!-- Biểu đồ cột - Doanh thu 6 tháng gần nhất -->
            <div style="background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 24px;">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--ink);">Doanh thu 6 tháng gần nhất</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Thông tin doanh thu -->
        <div style="background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 24px; margin-top: 24px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--ink);">Tổng quan doanh thu</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div style="text-align: center; padding: 20px; background: var(--bg); border: 1px solid var(--line); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="font-size: 14px; color: var(--muted); margin-bottom: 4px;">Tháng này</div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--ink);">@(((decimal)ViewBag.RevenueThisMonth).ToString("N0")) đ</div>
                </div>
                <div style="text-align: center; padding: 20px; background: var(--bg); border: 1px solid var(--line); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="font-size: 14px; color: var(--muted); margin-bottom: 4px;">Tháng trước</div>
                    <div style="font-size: 20px; font-weight: 600; color: var(--muted);">@(((decimal)ViewBag.RevenueLastMonth).ToString("N0")) đ</div>
                </div>
                @{
                    var revenueChange = (decimal)ViewBag.RevenueLastMonth > 0 
                        ? ((((decimal)ViewBag.RevenueThisMonth - (decimal)ViewBag.RevenueLastMonth) / (decimal)ViewBag.RevenueLastMonth) * 100)
                        : 0;
                    var isPositive = revenueChange >= 0;
                }
                @if ((decimal)ViewBag.RevenueLastMonth > 0)
                {
                    <div style="text-align: center; padding: 20px; background: var(--bg); border: 1px solid var(--line); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="font-size: 14px; color: var(--muted); margin-bottom: 4px;">Thay đổi</div>
                        <div style="font-size: 20px; font-weight: 600; color: @(isPositive ? "#065f46" : "#991b1b");">
                            @(isPositive ? "↑" : "↓") @Math.Abs(revenueChange).ToString("F1")%
                        </div>
                    </div>
                }
                <div style="text-align: center; padding: 20px; background: var(--bg); border: 1px solid var(--line); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <div style="font-size: 14px; color: var(--muted); margin-bottom: 4px;">Tổng doanh thu</div>
                    <div style="font-size: 20px; font-weight: 600; color: var(--ink);">@(((decimal)ViewBag.TotalRevenue).ToString("N0")) đ</div>
                </div>
            </div>
        </div>

        <!-- Hoạt động hôm nay -->
        <div style="background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 24px; margin-top: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 600; color: var(--ink);">
                    <i class="fas fa-calendar-day" style="margin-right: 8px; color: #f59e0b;"></i>
                    Hoạt động hôm nay
                </h3>
                <span style="font-size: 14px; color: var(--muted);">@DateTime.Now.ToString("dd/MM/yyyy")</span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div style="padding: 16px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-size: 13px; color: #92400e; margin-bottom: 4px;">Đơn hàng mới</div>
                            <div style="font-size: 24px; font-weight: 700; color: #78350f;">@ViewBag.TodayOrders</div>
                        </div>
                        <i class="fas fa-shopping-cart" style="font-size: 32px; color: #f59e0b; opacity: 0.6;"></i>
                    </div>
                </div>
                <div style="padding: 16px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-size: 13px; color: #1e40af; margin-bottom: 4px;">Doanh thu hôm nay</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1e3a8a;">@(((decimal)ViewBag.TodayRevenue).ToString("N0")) đ</div>
                        </div>
                        <i class="fas fa-dollar-sign" style="font-size: 32px; color: #3b82f6; opacity: 0.6;"></i>
                    </div>
                </div>
                <div style="padding: 16px; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-radius: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-size: 13px; color: #065f46; margin-bottom: 4px;">Khách hàng mới</div>
                            <div style="font-size: 24px; font-weight: 700; color: #064e3b;">@ViewBag.TodayCustomers</div>
                        </div>
                        <i class="fas fa-user-plus" style="font-size: 32px; color: #10b981; opacity: 0.6;"></i>
                    </div>
                </div>
                <div style="padding: 16px; background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border-radius: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-size: 13px; color: #831843; margin-bottom: 4px;">Cần xử lý</div>
                            <div style="font-size: 24px; font-weight: 700; color: #701a75;">@ViewBag.OrdersNeedingAttention</div>
                        </div>
                        <i class="fas fa-exclamation-circle" style="font-size: 32px; color: #ec4899; opacity: 0.6;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yêu cầu chờ duyệt & Thông tin nhanh -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-top: 24px;">
            <!-- Yêu cầu chờ duyệt -->
            <div style="background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--ink);">
                        <i class="fas fa-clipboard-check" style="margin-right: 8px; color: #8b5cf6;"></i>
                        Yêu cầu chờ duyệt
                    </h3>
                    @if (ViewBag.PendingApprovals > 0)
                    {
                        <span style="background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 600;">
                            @ViewBag.PendingApprovals
                        </span>
                    }
                </div>
                @if (ViewBag.PendingApprovals > 0)
                {
                    <p style="color: var(--muted); margin-bottom: 16px; font-size: 14px;">
                        Có <strong style="color: var(--ink);">@ViewBag.PendingApprovals</strong> yêu cầu đang chờ bạn duyệt
                    </p>
                    <a href="@Url.Action("Approvals","Admin")" style="display: inline-block; padding: 10px 20px; background: #8b5cf6; color: white; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.2s;">
                        <i class="fas fa-arrow-right" style="margin-right: 6px;"></i>
                        Xem và duyệt ngay
                    </a>
                }
                else
                {
                    <p style="color: var(--muted); font-size: 14px;">Không có yêu cầu nào chờ duyệt</p>
                }
            </div>

            <!-- Thông tin nhanh -->
            <div style="background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 24px;">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--ink);">
                    <i class="fas fa-info-circle" style="margin-right: 8px; color: #06b6d4;"></i>
                    Thông tin nhanh
                </h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-tag" style="color: #10b981;"></i>
                            <span style="font-size: 14px; color: var(--ink);">Mã giảm giá đang hoạt động</span>
                        </div>
                        <span style="font-weight: 600; color: var(--ink);">@ViewBag.ActiveDiscounts</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-ban" style="color: #f59e0b;"></i>
                            <span style="font-size: 14px; color: var(--ink);">Sản phẩm không hoạt động</span>
                        </div>
                        <span style="font-weight: 600; color: @(ViewBag.InactiveProducts > 0 ? "#dc2626" : "var(--ink)");">@ViewBag.InactiveProducts</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-user-friends" style="color: #3b82f6;"></i>
                            <span style="font-size: 14px; color: var(--ink);">Khách hàng mới (7 ngày)</span>
                        </div>
                        <span style="font-weight: 600; color: var(--ink);">@ViewBag.NewCustomersThisWeek</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-folder" style="color: #8b5cf6;"></i>
                            <span style="font-size: 14px; color: var(--ink);">Tổng số danh mục</span>
                        </div>
                        <span style="font-weight: 600; color: var(--ink);">@ViewBag.TotalCategories</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-newspaper" style="color: #06b6d4;"></i>
                            <span style="font-size: 14px; color: var(--ink);">Tổng số tin tức</span>
                        </div>
                        <span style="font-weight: 600; color: var(--ink);">@ViewBag.TotalNews</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-calendar-week" style="color: #10b981;"></i>
                            <span style="font-size: 14px; color: var(--ink);">Tin tức mới (7 ngày)</span>
                        </div>
                        <span style="font-weight: 600; color: var(--ink);">@ViewBag.NewsThisWeek</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top sản phẩm bán chạy & Đơn hàng gần đây -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-top: 24px;">
            <!-- Top 5 sản phẩm bán chạy -->
            <div style="background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 24px;">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--ink);">
                    <i class="fas fa-fire" style="margin-right: 8px; color: #ef4444;"></i>
                    Top 5 sản phẩm bán chạy
                </h3>
                @if (ViewBag.TopProducts != null && ((dynamic)ViewBag.TopProducts).Count > 0)
                {
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        @{
                            int rank = 1;
                            var topProductsList = (dynamic)ViewBag.TopProducts;
                        }
                        @foreach (var product in topProductsList)
                        {
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border-radius: 8px; border-left: 4px solid @(rank == 1 ? "#fbbf24" : rank == 2 ? "#94a3b8" : rank == 3 ? "#f97316" : "#e5e7eb");">
                                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                    <div style="width: 32px; height: 32px; background: @(rank == 1 ? "#fbbf24" : rank == 2 ? "#94a3b8" : rank == 3 ? "#f97316" : "#e5e7eb"); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px;">
                                        @rank
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--ink); margin-bottom: 4px;">@product.ProductName</div>
                                        <div style="font-size: 12px; color: var(--muted);">
                                            Đã bán: <strong>@product.TotalSold</strong> | Doanh thu: <strong>@(((decimal)product.TotalRevenue).ToString("N0")) đ</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            rank++;
                        }
                    </div>
                }
                else
                {
                    <p style="color: var(--muted); font-size: 14px; text-align: center; padding: 20px;">Chưa có dữ liệu sản phẩm bán chạy</p>
                }
            </div>

            <!-- Đơn hàng gần đây -->
            <div style="background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--ink);">
                        <i class="fas fa-clock" style="margin-right: 8px; color: #6366f1;"></i>
                        Đơn hàng gần đây
                    </h3>
                    <a href="@Url.Action("Orders","Admin")" style="font-size: 14px; color: #6366f1; text-decoration: none; font-weight: 600;">
                        Xem tất cả <i class="fas fa-arrow-right" style="margin-left: 4px;"></i>
                    </a>
                </div>
                @if (ViewBag.RecentOrders != null && ((dynamic)ViewBag.RecentOrders).Count > 0)
                {
                    <div style="display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto;">
                        @foreach (var order in (dynamic)ViewBag.RecentOrders)
                        {
                            <div style="padding: 12px; background: var(--bg); border-radius: 8px; border-left: 4px solid #6366f1;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--ink); margin-bottom: 4px;">@order.OrderCode</div>
                                        <div style="font-size: 12px; color: var(--muted);">@order.CustomerName</div>
                                    </div>
                                    <span style="padding: 4px 8px; background: @(order.Status == "Đã giao" ? "#d1fae5" : order.Status == "Chờ xác nhận" ? "#fef3c7" : order.Status == "Đang giao" ? "#dbeafe" : "#fee2e2"); color: @(order.Status == "Đã giao" ? "#065f46" : order.Status == "Chờ xác nhận" ? "#92400e" : order.Status == "Đang giao" ? "#1e40af" : "#991b1b"); border-radius: 4px; font-size: 11px; font-weight: 600;">
                                        @order.Status
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--muted);">
                                    <span>@order.BranchName</span>
                                    <span style="font-weight: 600; color: var(--ink);">@(((decimal)order.Total).ToString("N0")) đ</span>
                                </div>
                                <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                                    @(((DateTime)order.CreatedAt).ToString("dd/MM/yyyy HH:mm"))
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p style="color: var(--muted); font-size: 14px; text-align: center; padding: 20px;">Chưa có đơn hàng nào</p>
                }
            </div>
        </div>

        <!-- Top sản phẩm được yêu thích -->
        @if (ViewBag.TopWishlistedProducts != null && ((dynamic)ViewBag.TopWishlistedProducts).Count > 0)
        {
            <div style="background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 24px; margin-top: 24px;">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--ink);">
                    <i class="fas fa-heart" style="margin-right: 8px; color: #ec4899;"></i>
                    Top 5 sản phẩm được yêu thích
                </h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    @{
                        int wishlistRank = 1;
                        var topWishlistList = (dynamic)ViewBag.TopWishlistedProducts;
                    }
                    @foreach (var product in topWishlistList)
                    {
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border-radius: 8px; border-left: 4px solid @(wishlistRank == 1 ? "#ec4899" : wishlistRank == 2 ? "#f472b6" : wishlistRank == 3 ? "#fb7185" : "#fda4af");">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                <div style="width: 32px; height: 32px; background: @(wishlistRank == 1 ? "#ec4899" : wishlistRank == 2 ? "#f472b6" : wishlistRank == 3 ? "#fb7185" : "#fda4af"); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 14px;">
                                    @wishlistRank
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--ink); margin-bottom: 4px;">@product.ProductName</div>
                                    <div style="font-size: 12px; color: var(--muted);">
                                        <i class="fas fa-heart" style="color: #ec4899; margin-right: 4px;"></i>
                                        <strong>@product.WishlistCount</strong> lượt yêu thích
                                    </div>
                                </div>
                            </div>
                        </div>
                        wishlistRank++;
                    }
                </div>
            </div>
        }

        <!-- Thống kê theo chi nhánh -->
        @if (ViewBag.BranchStats != null && ((dynamic)ViewBag.BranchStats).Count > 0)
        {
            <div style="background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 24px; margin-top: 24px;">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--ink);">
                    <i class="fas fa-store" style="margin-right: 8px; color: #10b981;"></i>
                    Top 3 chi nhánh hoạt động tốt nhất
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                    @{
                        int branchRank = 1;
                        var branchStatsList = (dynamic)ViewBag.BranchStats;
                    }
                    @foreach (var branch in branchStatsList)
                    {
                        <div style="padding: 16px; background: linear-gradient(135deg, @(branchRank == 1 ? "#fef3c7" : branchRank == 2 ? "#e0e7ff" : "#fce7f3") 0%, @(branchRank == 1 ? "#fde68a" : branchRank == 2 ? "#c7d2fe" : "#fbcfe8") 100%); border-radius: 8px; border-left: 4px solid @(branchRank == 1 ? "#fbbf24" : branchRank == 2 ? "#6366f1" : "#ec4899");">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <div style="width: 28px; height: 28px; background: @(branchRank == 1 ? "#fbbf24" : branchRank == 2 ? "#6366f1" : "#ec4899"); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 12px;">
                                    @branchRank
                                </div>
                                <div style="font-weight: 600; color: var(--ink);">@branch.BranchName</div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                    <span style="color: var(--muted);">Số đơn:</span>
                                    <span style="font-weight: 600; color: var(--ink);">@branch.OrderCount</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                    <span style="color: var(--muted);">Doanh thu:</span>
                                    <span style="font-weight: 600; color: var(--ink);">@(((decimal)branch.Revenue).ToString("N0")) đ</span>
                                </div>
                            </div>
                        </div>
                        branchRank++;
                    }
                </div>
            </div>
        }

        <div style="margin-top: 32px;">
            <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px; color: var(--ink);">
                Chức năng quản trị
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <a href="@Url.Action("Employees","Admin")" style="display: block; padding: 20px; background: var(--card); border: 1px solid var(--line); border-radius: 12px; text-align: center; transition: all 0.2s;">
                    <div style="font-size: 32px; margin-bottom: 8px; color: var(--admin-primary);"><i class="fas fa-users"></i></div>
                    <div style="font-weight: 600; color: var(--ink);">Quản lý nhân viên</div>
                </a>
                <a href="@Url.Action("Products","Admin")" style="display: block; padding: 20px; background: var(--card); border: 1px solid var(--line); border-radius: 12px; text-align: center; transition: all 0.2s;">
                    <div style="font-size: 32px; margin-bottom: 8px; color: var(--admin-primary);"><i class="fas fa-box"></i></div>
                    <div style="font-weight: 600; color: var(--ink);">Quản lý sản phẩm</div>
                </a>
                <a href="@Url.Action("Orders","Admin")" style="display: block; padding: 20px; background: var(--card); border: 1px solid var(--line); border-radius: 12px; text-align: center; transition: all 0.2s;">
                    <div style="font-size: 32px; margin-bottom: 8px; color: var(--admin-primary);"><i class="fas fa-shopping-cart"></i></div>
                    <div style="font-weight: 600; color: var(--ink);">Quản lý đơn hàng</div>
                </a>
                <a href="@Url.Action("Branches","Admin")" style="display: block; padding: 20px; background: var(--card); border: 1px solid var(--line); border-radius: 12px; text-align: center; transition: all 0.2s;">
                    <div style="font-size: 32px; margin-bottom: 8px; color: var(--admin-primary);"><i class="fas fa-store"></i></div>
                    <div style="font-weight: 600; color: var(--ink);">Quản lý chi nhánh</div>
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Dữ liệu từ server
        @{
            var orderStatusJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.OrderStatusData, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase });
            var monthlyRevenueJson = System.Text.Json.JsonSerializer.Serialize(ViewBag.MonthlyRevenueData, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase });
        }
        const orderStatusData = @Html.Raw(orderStatusJson);
        const monthlyRevenueData = @Html.Raw(monthlyRevenueJson);
        
        console.log('Order Status Data:', orderStatusData); // Debug
        console.log('Monthly Revenue Data:', monthlyRevenueData); // Debug

        // Biểu đồ tròn - Đơn hàng theo trạng thái
        const orderStatusCtx = document.getElementById('orderStatusChart');
        if (orderStatusCtx && orderStatusData) {
            new Chart(orderStatusCtx, {
                type: 'doughnut',
                data: {
                    labels: orderStatusData.labels || orderStatusData.Labels || [],
                    datasets: [{
                        data: orderStatusData.data || orderStatusData.Data || [],
                        backgroundColor: [
                            '#cbd5e1', // Chờ xác nhận - xám nhạt
                            '#dbeafe', // Đã xác nhận - xanh dương nhạt
                            '#ddd6fe', // Đang giao - tím nhạt
                            '#d1fae5', // Đã giao - xanh lá nhạt
                            '#fee2e2', // Đã hủy - đỏ nhạt
                            '#e0e7ff', // Chờ hoàn tiền - xanh nhạt
                            '#6366f1'  // Đã hoàn tiền - indigo
                        ],
                        borderColor: [
                            '#94a3b8', // Chờ xác nhận
                            '#60a5fa', // Đã xác nhận
                            '#a78bfa', // Đang giao
                            '#34d399', // Đã giao
                            '#f87171', // Đã hủy
                            '#6366f1', // Chờ hoàn tiền
                            '#4f46e5'  // Đã hoàn tiền
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed + ' đơn hàng';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Biểu đồ cột - Doanh thu 6 tháng gần nhất
        const revenueCtx = document.getElementById('revenueChart');
        if (revenueCtx) {
            // Đảm bảo có dữ liệu
            const revenueData = monthlyRevenueData || [];
 const labels = revenueData.map(m =>
{
    let raw = m.month || m.Month || '';     // ví dụ: "2025-11-01T00:00:00+07:00"

    // Xóa timezone
    raw = raw.replace(/\+.*$/, "");         // bỏ +07:00:00

    // Parse lại tháng
    const dt = new Date(raw);
    return `Tháng ${dt.getMonth() + 1}`;               // trả về số tháng
});

            const data = revenueData.map(m => parseFloat(m.revenue || m.Revenue || 0));
            
            console.log('Revenue Chart - Labels:', labels);
            console.log('Revenue Chart - Data:', data);
            
            if (labels.length === 0) {
                // Nếu không có dữ liệu, hiển thị thông báo
                revenueCtx.parentElement.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--muted);">Chưa có dữ liệu doanh thu</div>';
            } else {
                new Chart(revenueCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Doanh thu (VNĐ)',
                            data: data,
                            backgroundColor: 'rgba(99, 102, 241, 0.8)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y || 0;
                                        return 'Doanh thu: ' + new Intl.NumberFormat('vi-VN').format(value) + ' đ';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return (value / 1000000).toFixed(1) + 'M';
                                        } else if (value >= 1000) {
                                            return (value / 1000).toFixed(1) + 'K';
                                        }
                                        return value;
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        }
    </script>
}
